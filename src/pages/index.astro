// src/pages/index.astro
import Layout from '../layout/Layout.astro';
---

<Layout>
  <div style="text-align: center; padding: 40px 20px;">
    <!-- Breadcrumbs -->
    <nav style="
      margin-bottom: 30px;
      text-align: left;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    ">
      <div style="
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: #666;
      ">
        <span style="color: #3b82f6;">üè†</span>
        <span style="color: #3b82f6;">Inicio</span>
      </div>
    </nav>
    
    <h1 style="font-size: 2.5rem; color: #333; margin-bottom: 10px;">
      üéØ Astro + Railway (PostgreSQL)
    </h1>
    <p style="color: #666; font-size: 1.1rem; margin-bottom: 40px;">
      Los datos se guardan en: <code>mensajescaptcha</code>
    </p>
    
    <div style="
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    ">
      
      <div style="margin-bottom: 25px;">
        <label style="display: block; text-align: left; margin-bottom: 10px; font-weight: 600; color: #555;">
          üìù Tu mensaje:
        </label>
        <input 
          type="text" 
          id="miCampoUnico"
          placeholder="Escribe algo para PostgreSQL..."
          style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;"
        >
      </div>
      
      <div style="margin: 25px 0;">
        <div class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001"></div>
      </div>
      
      <button 
        id="botonEnviar"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; width: 100%;"
      >
        üíæ Guardar en PostgreSQL
      </button>
      
      <div id="resultado" style="margin-top: 25px; padding: 20px; border-radius: 10px; display: none; text-align: left;"></div>
      
      <div id="estadoSistema" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; font-size: 0.9rem; color: #666;">
        <div>üîç <strong>Estado:</strong> <span id="estadoTexto">Verificando...</span></div>
        <div style="margin-top: 5px;">üåê <small id="backendURL">...</small></div>
      </div>
    </div>

    <!-- Enlaces a otras p√°ginas -->
    <div style="
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 10px;
      max-width: 500px;
      margin: 40px auto;
    ">
      <h3 style="color: #333; margin-bottom: 15px;">üåê Otras p√°ginas de prueba</h3>
      <p style="color: #666; font-size: 0.95rem; margin-bottom: 20px;">
        Estas p√°ginas funcionan localmente sin conexi√≥n a la base de datos
      </p>
      <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
        <a 
          href="/violet-virgo/formulario-validacion" 
          style="
            padding: 12px 25px;
            background: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
          "
          onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-2px)';"
          onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)';"
        >
          üìù Formulario de Validaci√≥n
        </a>
        <a 
          href="/violet-virgo/error-captcha" 
          style="
            padding: 12px 25px;
            background: #ef4444;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
          "
          onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-2px)';"
          onmouseout="this.style.background='#ef4444'; this.style.transform='translateY(0)';"
        >
          ‚ö†Ô∏è Error Captcha (Demo)
        </a>
      </div>
    </div>
  </div>

  <script>
    // ‚úÖ CORRECCI√ìN 1: Usa la URL de tu backend Express en Railway
    const BACKEND_URL = 'https://violet-virgo-production.up.railway.app';
    
    // 1. Cargar hCaptcha din√°micamente
    const script = document.createElement('script');
    script.src = 'https://js.hcaptcha.com/1/api.js';
    script.async = true;
    document.head.appendChild(script);
    
    // 2. Verificar Salud del Sistema al cargar
    async function verificarSalud() {
      const estadoTexto = document.getElementById('estadoTexto');
      const backendURL = document.getElementById('backendURL');
      backendURL.textContent = BACKEND_URL;
      
      try {
        const res = await fetch(`${BACKEND_URL}/health`);
        const data = await res.json();
        
        if (data.status === '‚úÖ OK') {
          let html = `<span style="color: #10b981;">‚úÖ Backend Activo</span>`;
          if (data.tabla && data.tabla.exists) {
            html += ` | <span style="color: #10b981;">${data.tabla.registros || 0} registros</span>`;
          } else {
            html += ` | <span style="color: #ef4444;">Tabla no encontrada</span>`;
          }
          estadoTexto.innerHTML = html;
        } else {
          throw new Error(data.error || 'Error desconocido');
        }
      } catch (e) {
        console.error('Error conexi√≥n backend:', e);
        estadoTexto.innerHTML = '<span style="color: #ef4444;">‚ùå Backend Offline</span>';
      }
    }

    document.addEventListener('DOMContentLoaded', verificarSalud);

    // 3. L√≥gica de Env√≠o
    document.getElementById('botonEnviar').addEventListener('click', async function() {
      const campo = document.getElementById('miCampoUnico');
      const resultado = document.getElementById('resultado');
      const texto = campo.value.trim();
      
      // ‚úÖ CORRECCI√ìN 2: Obtener token de hCaptcha correctamente
      let tokenCaptcha;
      if (window.hcaptcha) {
        tokenCaptcha = hcaptcha.getResponse();
      } else {
        tokenCaptcha = document.querySelector('[name="h-captcha-response"]')?.value;
      }

      if (!texto || !tokenCaptcha) {
        alert("Por favor escribe un mensaje y completa el captcha");
        return;
      }

      this.disabled = true;
      this.textContent = 'Enviando...';

      try {
        const response = await fetch(`${BACKEND_URL}/api/guardar`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ 
            texto: texto, 
            hcaptcha: tokenCaptcha 
          })
        });

        const data = await response.json();
        console.log('Respuesta backend:', data);

        if (data.success) {
          resultado.style.display = 'block';
          resultado.style.background = '#d1fae5';
          resultado.innerHTML = `
            <strong>‚úÖ √âxito!</strong><br>
            ID: ${data.id}<br>
            Fecha: ${new Date(data.fecha).toLocaleString()}
          `;
          campo.value = '';
          // Resetear captcha
          if (window.hcaptcha) {
            hcaptcha.reset();
          }
        } else {
          throw new Error(data.error || data.detalle || 'Error desconocido');
        }
      } catch (err) {
        console.error('Error env√≠o:', err);
        resultado.style.display = 'block';
        resultado.style.background = '#fee2e2';
        resultado.innerHTML = `<strong>‚ùå Error:</strong><br>${err.message}`;
      } finally {
        this.disabled = false;
        this.textContent = 'üíæ Guardar en PostgreSQL';
      }
    });
  </script>
</Layout>