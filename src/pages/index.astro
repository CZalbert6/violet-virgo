---
// src/pages/index.astro
import Layout from '../layout/Layout.astro';
---

<Layout>
  <div style="text-align: center; padding: 40px 20px;">
    <h1 style="font-size: 2.5rem; color: #333; margin-bottom: 10px;">
      üéØ Astro + Railway (PostgreSQL)
    </h1>
    <p style="color: #666; font-size: 1.1rem; margin-bottom: 40px;">
      Los datos se guardan en la tabla: <code>mensajescaptcha</code>
    </p>
    
    <div style="
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    ">
      
      <div style="margin-bottom: 25px;">
        <label style="display: block; text-align: left; margin-bottom: 10px; font-weight: 600; color: #555;">
          üìù Tu mensaje:
        </label>
        <input 
          type="text" 
          id="miCampoUnico"
          placeholder="Escribe algo para la base de datos..."
          style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;"
        >
      </div>
      
      <div style="margin: 25px 0;">
        <div class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001"></div>
      </div>
      
      <button 
        id="botonEnviar"
        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px; border: none; border-radius: 10px; font-size: 18px; font-weight: 600; cursor: pointer; width: 100%;"
      >
        üíæ Guardar en PostgreSQL
      </button>
      
      <div id="resultado" style="margin-top: 25px; padding: 20px; border-radius: 10px; display: none; text-align: left;"></div>
      
      <div id="estadoSistema" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; font-size: 0.9rem; color: #666;">
        <div>üîç <strong>Estado:</strong> <span id="estadoTexto">Verificando...</span></div>
        <div style="margin-top: 5px;">üåê <small id="backendURL">...</small></div>
      </div>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'https://violet-virgo-production.up.railway.app';
    
    // 1. Cargar hCaptcha din√°micamente
    const script = document.createElement('script');
    script.src = 'https://js.hcaptcha.com/1/api.js';
    script.async = true;
    document.head.appendChild(script);
    
    // 2. Verificar Salud del Sistema al cargar
    async function verificarSalud() {
      const estadoTexto = document.getElementById('estadoTexto');
      const backendURL = document.getElementById('backendURL');
      backendURL.textContent = BACKEND_URL;
      
      try {
        const res = await fetch(`${BACKEND_URL}/health`);
        const data = await res.json();
        
        if (data.status === '‚úÖ OK') {
          let html = `<span style="color: #10b981;">‚úÖ Conectado</span>`;
          if (data.tabla === '‚úÖ Existe') {
            html += ` | <span style="color: #10b981;">Tabla Lista</span>`;
          } else {
            html += ` | <span style="color: #ef4444;">Tabla no encontrada</span>`;
          }
          estadoTexto.innerHTML = html;
        }
      } catch (e) {
        estadoTexto.innerHTML = '<span style="color: #ef4444;">‚ùå Backend Offline</span>';
      }
    }

    document.addEventListener('DOMContentLoaded', verificarSalud);

    // 3. L√≥gica de Env√≠o
    document.getElementById('botonEnviar').addEventListener('click', async function() {
      const campo = document.getElementById('miCampoUnico');
      const resultado = document.getElementById('resultado');
      const texto = campo.value.trim();
      const tokenCaptcha = document.querySelector('[name="h-captcha-response"]')?.value;

      if (!texto || !tokenCaptcha) {
        alert("Por favor escribe un mensaje y completa el captcha");
        return;
      }

      this.disabled = true;
      this.textContent = 'Enviando...';

      try {
        const response = await fetch(`${BACKEND_URL}/api/guardar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ texto, hcaptcha: tokenCaptcha })
        });

        const data = await response.json();

        if (data.success) {
          resultado.style.display = 'block';
          resultado.style.background = '#d1fae5';
          resultado.innerHTML = `<strong>‚úÖ √âxito!</strong><br>ID generado: ${data.id}`;
          campo.value = '';
          if (window.hcaptcha) window.hcaptcha.reset();
        } else {
          throw new Error(data.error || 'Error desconocido');
        }
      } catch (err) {
        resultado.style.display = 'block';
        resultado.style.background = '#fee2e2';
        resultado.innerHTML = `<strong>‚ùå Error:</strong><br>${err.message}`;
      } finally {
        this.disabled = false;
        this.textContent = 'üíæ Guardar en PostgreSQL';
      }
    });
  </script>
</Layout>