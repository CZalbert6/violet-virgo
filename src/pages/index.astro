---
// src/pages/index.astro
---

<nav style="
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 15px 20px;
  border-radius: 0 0 15px 15px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  margin-bottom: 40px;
">
  <div style="
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
  ">
    <!-- Logo/T√≠tulo -->
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="
        background: white;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #667eea;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      ">
        üöÄ
      </div>
      <h1 style="color: white; margin: 0; font-size: 1.5rem; font-weight: 600;">
        Astro + PostgreSQL
      </h1>
    </div>

    <!-- Men√∫ de navegaci√≥n -->
    <div style="
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    ">
      <a 
        href="/" 
        style="
          padding: 10px 20px;
          background: rgba(255, 255, 255, 0.3);
          color: white;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 600;
          transition: all 0.3s;
          border: 2px solid rgba(255, 255, 255, 0.5);
          display: flex;
          align-items: center;
          gap: 8px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.4)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 0, 0, 0.3)';"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.2)';"
      >
        <span>üè†</span>
        <span>Inicio</span>
      </a>
      
      <a 
        href="formulario-validacion" 
        style="
          padding: 10px 20px;
          background: rgba(255, 255, 255, 0.2);
          color: white;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 500;
          transition: all 0.3s;
          border: 1px solid rgba(255, 255, 255, 0.3);
          display: flex;
          align-items: center;
          gap: 8px;
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-2px)';"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='translateY(0)';"
      >
        <span>üìù</span>
        <span>Formulario</span>
      </a>
      
      <a 
        href="error-captcha" 
        style="
          padding: 10px 20px;
          background: rgba(255, 255, 255, 0.2);
          color: white;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 500;
          transition: all 0.3s;
          border: 1px solid rgba(255, 255, 255, 0.3);
          display: flex;
          align-items: center;
          gap: 8px;
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-2px)';"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='translateY(0)';"
      >
        <span>‚ö†Ô∏è</span>
        <span>Error Captcha</span>
      </a>
      
      <a 
        href="carrusel" 
        style="
          padding: 10px 20px;
          background: rgba(255, 255, 255, 0.2);
          color: white;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 500;
          transition: all 0.3s;
          border: 1px solid rgba(255, 255, 255, 0.3);
          display: flex;
          align-items: center;
          gap: 8px;
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-2px)';"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='translateY(0)';"
      >
        <span>üñºÔ∏è</span>
        <span>Carrusel</span>
      </a>
    </div>
  </div>
</nav>

<div style="text-align: center; padding: 20px;">
  <!-- T√≠tulo principal -->
  <h1 style="font-size: 2.5rem; color: #333; margin-bottom: 10px;">
    üéØ CRUD - Mensajes PostgreSQL
  </h1>
  
  
  <!-- Formulario de Creaci√≥n -->
  <div style="
    max-width: 600px;
    margin: 0 auto 40px;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border-top: 4px solid #10b981;
  ">
    <div style="margin-bottom: 20px;">
      <div style="
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      ">
        <div style="font-size: 24px; margin-bottom: 5px;">üìù</div>
        <div style="font-weight: 600; font-size: 1.2rem;">Crear Nuevo Mensaje</div>
        <div style="font-size: 0.9rem; opacity: 0.9;">Tabla: <code>mensajescaptcha</code></div>
      </div>
      
      <label style="display: block; text-align: left; margin-bottom: 10px; font-weight: 600; color: #555;">
        Tu mensaje:
      </label>
      <input 
        type="text" 
        id="inputCrearMensaje"
        maxlength="50"
        placeholder="Escribe un mensaje para guardar... (m√°x. 50 caracteres)"
        style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;"
      >
      <div style="display: flex; justify-content: flex-end; margin-top: 5px;">
        <span id="contadorCrear" style="font-size: 12px; color: #6b7280;">0/50</span>
      </div>
    </div>
    
    <div style="margin: 20px 0;">
      <div class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001"></div>
    </div>
    
    <button 
      id="btnCrear"
      style="
        background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
        color: white; 
        padding: 16px; 
        border: none; 
        border-radius: 10px; 
        font-size: 18px; 
        font-weight: 600; 
        cursor: pointer; 
        width: 100%;
        transition: all 0.3s;
      "
      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(16, 185, 129, 0.3)';"
      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
    >
      üíæ Guardar en PostgreSQL
    </button>
    
    <div id="resultadoCrear" style="
      margin-top: 20px; 
      padding: 15px; 
      border-radius: 10px; 
      display: none; 
      text-align: left;
      transition: all 0.3s;
    "></div>
  </div>
  
  <!-- Formulario de Edici√≥n -->
  <div id="formularioEdicion" style="
    max-width: 600px;
    margin: 0 auto 40px;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border-top: 4px solid #3b82f6;
    display: none;
  ">
    <div style="margin-bottom: 20px;">
      <div style="
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      ">
        <div style="font-size: 24px; margin-bottom: 5px;">‚úèÔ∏è</div>
        <div style="font-weight: 600; font-size: 1.2rem;">Editar Mensaje</div>
      </div>
      
      <label style="display: block; text-align: left; margin-bottom: 10px; font-weight: 600; color: #555;">
        Nuevo mensaje:
      </label>
      <input 
        type="text" 
        id="inputEditarMensaje"
        maxlength="50"
        placeholder="Escribe el nuevo mensaje... (m√°x. 50 caracteres)"
        style="width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px;"
      >
      <div style="display: flex; justify-content: space-between; margin-top: 5px;">
        <span style="font-size: 12px; color: #6b7280;">Original: "<span id="mensajeOriginal"></span>"</span>
        <span id="contadorEditar" style="font-size: 12px; color: #6b7280;">0/50</span>
      </div>
    </div>
    
    <div style="display: flex; gap: 15px;">
      <button 
        id="btnActualizar"
        style="
          flex: 1;
          background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); 
          color: white; 
          padding: 16px; 
          border: none; 
          border-radius: 10px; 
          font-size: 16px; 
          font-weight: 600; 
          cursor: pointer;
          transition: all 0.3s;
        "
        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(59, 130, 246, 0.3)';"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
      >
        ‚úÖ Actualizar
      </button>
      
      <button 
        id="btnCancelarEdicion"
        style="
          flex: 1;
          background: #f1f5f9;
          color: #64748b;
          padding: 16px; 
          border: 2px solid #e2e8f0;
          border-radius: 10px; 
          font-size: 16px; 
          font-weight: 600; 
          cursor: pointer;
          transition: all 0.3s;
        "
        onmouseover="this.style.background='#e2e8f0';"
        onmouseout="this.style.background='#f1f5f9';"
      >
        ‚ùå Cancelar
      </button>
    </div>
    
    <div id="resultadoEditar" style="
      margin-top: 20px; 
      padding: 15px; 
      border-radius: 10px; 
      display: none; 
      text-align: left;
      transition: all 0.3s;
    "></div>
  </div>
  
  <!-- Lista de Mensajes (ABAJO) -->
  <div style="
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    border-top: 4px solid #8b5cf6;
  ">
    <div style="margin-bottom: 20px;">
      <div style="
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      ">
        <div style="font-size: 24px; margin-bottom: 5px;">üìã</div>
        <div style="font-weight: 600; font-size: 1.2rem;">Lista de Mensajes</div>
        <div style="font-size: 0.9rem; opacity: 0.9;">
          Total: <span id="totalMensajes">0</span> mensajes
        </div>
      </div>
      
      <!-- Controles de b√∫squeda y filtro -->
      <div style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
          <input 
            type="text" 
            id="inputBuscar"
            placeholder="Buscar en mensajes..."
            style="
              flex: 1;
              min-width: 200px;
              padding: 12px 15px;
              border: 2px solid #e2e8f0;
              border-radius: 8px;
              font-size: 14px;
            "
            onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
            onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';"
          >
          <button 
            id="btnRecargar"
            style="
              background: #3b82f6;
              color: white;
              border: none;
              padding: 12px 20px;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.3s;
              display: flex;
              align-items: center;
              gap: 5px;
              white-space: nowrap;
            "
            onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-2px)';"
            onmouseout="this.style.background='#3b82f6'; this.style.transform='translateY(0)';"
          >
            üîÑ Recargar
          </button>
        </div>
        
        <!-- Filtros -->
        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
          <select 
            id="selectOrden"
            style="
              flex: 1;
              min-width: 200px;
              padding: 10px;
              border: 2px solid #e2e8f0;
              border-radius: 8px;
              font-size: 14px;
              background: white;
            "
          >
            <option value="fecha_desc">M√°s recientes primero</option>
            <option value="fecha_asc">M√°s antiguos primero</option>
            <option value="texto_asc">A-Z</option>
            <option value="texto_desc">Z-A</option>
          </select>
          
          <select 
            id="selectLimite"
            style="
              flex: 1;
              min-width: 150px;
              padding: 10px;
              border: 2px solid #e2e8f0;
              border-radius: 8px;
              font-size: 14px;
              background: white;
            "
          >
            <option value="5">5 por p√°gina</option>
            <option value="10" selected>10 por p√°gina</option>
            <option value="20">20 por p√°gina</option>
            <option value="50">50 por p√°gina</option>
          </select>
        </div>
      </div>
      
      <!-- Lista de mensajes -->
      <div id="listaMensajes" style="
        min-height: 200px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 15px;
        background: #f8fafc;
      ">
        <div style="text-align: center; padding: 40px; color: #94a3b8;">
          <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
          <p>Cargando mensajes...</p>
        </div>
      </div>
      
      <!-- Paginaci√≥n -->
      <div id="paginacion" style="
        display: none;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        padding: 15px;
        background: #f1f5f9;
        border-radius: 10px;
        flex-wrap: wrap;
        gap: 10px;
      ">
        <button 
          id="btnAnterior"
          style="
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
          "
          onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-2px)';"
          onmouseleave="this.style.background='#3b82f6'; this.style.transform='translateY(0)';"
          disabled
        >
          ‚óÄ Anterior
        </button>
        
        <div style="font-size: 14px; color: #475569; text-align: center;">
          P√°gina <span id="paginaActual" style="font-weight: bold;">1</span> de <span id="totalPaginas" style="font-weight: bold;">1</span>
        </div>
        
        <button 
          id="btnSiguiente"
          style="
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
          "
          onmouseover="this.style.background='#2563eb'; this.style.transform='translateY(-2px)';"
          onmouseleave="this.style.background='#3b82f6'; this.style.transform='translateY(0)';"
          disabled
        >
          Siguiente ‚ñ∂
        </button>
      </div>
    </div>
  </div>
  
  <!-- Estado del sistema -->
  <div id="estadoSistema" style="
    max-width: 1200px;
    margin: 40px auto 0;
    padding: 25px;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 15px;
    border-left: 4px solid #3b82f6;
  ">
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
      <div style="
        background: #3b82f6;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
      ">
        üîç
      </div>
      <h3 style="margin: 0; color: #333; font-size: 1.2rem;">Estado del Sistema</h3>
    </div>
    
    <div style="margin-bottom: 10px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
      <strong style="color: #555; min-width: 80px;">Backend:</strong> 
      <span id="estadoTexto" style="font-size: 1rem;">Verificando...</span>
    </div>
    
    <div style="
      padding: 15px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      color: #475569;
      margin-top: 15px;
    ">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 18px;">üåê</span>
        <span id="backendURL" style="font-family: monospace; word-break: break-all;">...</span>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmaci√≥n -->
<div id="modalConfirmacion" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
">
  <div style="
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
    animation: aparecer 0.3s ease-out;
  ">
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="
        background: #ef4444;
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin: 0 auto 15px;
      ">
        ‚ö†Ô∏è
      </div>
      <h3 style="color: #333; margin-bottom: 10px; font-size: 1.3rem;" id="modalTitulo"></h3>
      <p style="color: #666;" id="modalMensaje"></p>
    </div>
    
    <div style="display: flex; gap: 15px;">
      <button 
        id="btnModalConfirmar"
        style="
          flex: 1;
          background: #ef4444;
          color: white;
          padding: 15px;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
        "
        onmouseover="this.style.background='#dc2626'; this.style.transform='translateY(-2px)';"
        onmouseout="this.style.background='#ef4444'; this.style.transform='translateY(0)';"
      >
        Confirmar
      </button>
      
      <button 
        id="btnModalCancelar"
        style="
          flex: 1;
          background: #f1f5f9;
          color: #64748b;
          padding: 15px;
          border: 2px solid #e2e8f0;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
        "
        onmouseover="this.style.background='#e2e8f0';"
        onmouseout="this.style.background='#f1f5f9';"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>

<style>
  @media (max-width: 768px) {
    .contenedor-principal {
      grid-template-columns: 1fr !important;
    }
    
    .filtros-container {
      flex-direction: column !important;
    }
    
    .botones-container {
      flex-direction: column !important;
    }
  }
  
  @keyframes aparecer {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  
  .mensaje-item {
    transition: all 0.3s ease;
  }
  
  .mensaje-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1) !important;
  }
</style>

<script>
  // ====================
  // CONFIGURACI√ìN
  // ====================
  const BACKEND_URL = 'https://violet-virgo-production.up.railway.app';
  let mensajes = [];
  let paginaActual = 1;
  let limitePorPagina = 10;
  let orden = 'fecha_desc';
  let busqueda = '';
  let mensajeAEliminar = null;
  let mensajeAEditar = null;
  
  // ====================
  // FUNCIONES PRINCIPALES - CORREGIDAS
  // ====================
  
  // 1. Verificar Salud del Sistema
  async function verificarSalud() {
    const estadoTexto = document.getElementById('estadoTexto');
    const backendURL = document.getElementById('backendURL');
    backendURL.textContent = BACKEND_URL;
    
    try {
      const res = await fetch(`${BACKEND_URL}/health`);
      const data = await res.json();
      
      if (data.status === '‚úÖ OK') {
        let html = `<span style="color: #10b981; font-weight: 600;">‚úÖ Conectado</span>`;
        
        if (data.total_mensajes !== undefined) {
          html += ` | <span style="color: #3b82f6;">Mensajes: ${data.total_mensajes}</span>`;
          document.getElementById('totalMensajes').textContent = data.total_mensajes;
        }
        if (data.total_imagenes !== undefined) {
          html += ` | <span style="color: #8b5cf6;">Im√°genes: ${data.total_imagenes}</span>`;
        }
        
        estadoTexto.innerHTML = html;
      } else {
        throw new Error(data.error || 'Error desconocido');
      }
    } catch (e) {
      console.error('Error conexi√≥n backend:', e);
      estadoTexto.innerHTML = '<span style="color: #ef4444; font-weight: 600;">‚ùå Sin conexi√≥n</span>';
    }
  }
  
  // 2. Cargar Mensajes desde el backend - CORREGIDO
  async function cargarMensajes() {
    try {
      // Mostrar estado de carga
      document.getElementById('listaMensajes').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #94a3b8;">
          <div style="font-size: 32px; margin-bottom: 10px;">‚è≥</div>
          <p>Cargando mensajes...</p>
        </div>
      `;
      
      // Construir URL con par√°metros
      let url = `${BACKEND_URL}/api/mensajes`;
      
      console.log('üîÑ Cargando mensajes desde:', url);
      
      const respuesta = await fetch(url);
      
      if (!respuesta.ok) {
        throw new Error(`HTTP ${respuesta.status}: No se pudo cargar los mensajes`);
      }
      
      const data = await respuesta.json();
      console.log('üì• Respuesta del servidor:', data);
      
      if (data.success) {
        mensajes = data.mensajes || [];
        actualizarListaMensajes();
        actualizarPaginacion();
      } else {
        throw new Error(data.message || 'Error del servidor');
      }
    } catch (error) {
      console.error('‚ùå Error cargando mensajes:', error);
      document.getElementById('listaMensajes').innerHTML = `
        <div style="text-align: center; padding: 40px; color: #ef4444;">
          <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
          <p style="font-weight: 600; margin-bottom: 10px;">Error al cargar mensajes</p>
          <p style="font-size: 0.9rem; margin-bottom: 20px;">${error.message}</p>
          <button onclick="cargarMensajes()" style="
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
          ">
            üîÑ Reintentar
          </button>
        </div>
      `;
    }
  }
  
  // 3. Actualizar Lista de Mensajes en el DOM (SIN ID)
  function actualizarListaMensajes() {
    const container = document.getElementById('listaMensajes');
    
    // Aplicar filtros locales (ya que el backend no los soporta)
    let mensajesFiltrados = [...mensajes];
    
    // Filtro de b√∫squeda
    if (busqueda) {
      const busquedaLower = busqueda.toLowerCase();
      mensajesFiltrados = mensajesFiltrados.filter(m => 
        m.texto.toLowerCase().includes(busquedaLower)
      );
    }
    
    // Ordenamiento
    mensajesFiltrados.sort((a, b) => {
      switch(orden) {
        case 'fecha_desc':
          return new Date(b.created_at) - new Date(a.created_at);
        case 'fecha_asc':
          return new Date(a.created_at) - new Date(b.created_at);
        case 'texto_asc':
          return a.texto.localeCompare(b.texto);
        case 'texto_desc':
          return b.texto.localeCompare(a.texto);
        default:
          return 0;
      }
    });
    
    // Paginaci√≥n local
    const totalPaginas = Math.ceil(mensajesFiltrados.length / limitePorPagina);
    const inicio = (paginaActual - 1) * limitePorPagina;
    const fin = inicio + limitePorPagina;
    const mensajesPaginados = mensajesFiltrados.slice(inicio, fin);
    
    if (mensajesPaginados.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #94a3b8;">
          <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
          <p>No hay mensajes encontrados</p>
          <p style="font-size: 0.9rem; margin-top: 10px;">${busqueda ? 'Intenta con otra b√∫squeda' : 'Crea tu primer mensaje'}</p>
        </div>
      `;
      document.getElementById('paginacion').style.display = 'none';
      return;
    }
    
    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';
    
    mensajesPaginados.forEach((mensaje) => {
      const fecha = new Date(mensaje.created_at).toLocaleString('es-ES', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      html += `
        <div class="mensaje-item" style="
          background: white;
          border-radius: 12px;
          padding: 20px;
          border-left: 4px solid #3b82f6;
          box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        ">
          <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 12px;">
            <div style="font-size: 0.8rem; color: #94a3b8;">
              ${fecha}
            </div>
          </div>
          
          <div style="
            color: #475569;
            margin-bottom: 20px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            font-size: 0.95rem;
            line-height: 1.5;
            min-height: 60px;
            word-wrap: break-word;
          ">
            ${mensaje.texto}
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button 
              class="btn-editar"
              data-id="${mensaje.id}"
              data-texto="${mensaje.texto.replace(/"/g, '&quot;')}"
              style="
                background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 5px;
              "
            >
              ‚úèÔ∏è Editar
            </button>
            
            <button 
              class="btn-eliminar"
              data-id="${mensaje.id}"
              data-texto="${mensaje.texto.replace(/"/g, '&quot;')}"
              style="
                background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 5px;
              "
            >
              üóëÔ∏è Eliminar
            </button>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
    
    // Actualizar contador
    document.getElementById('totalMensajes').textContent = mensajes.length;
    
    // Agregar event listeners a los botones
    document.querySelectorAll('.btn-editar').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const texto = this.getAttribute('data-texto');
        iniciarEdicion(id, texto);
      });
    });
    
    document.querySelectorAll('.btn-eliminar').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const texto = this.getAttribute('data-texto');
        mostrarModalConfirmacion(id, texto);
      });
    });
  }
  
  // 4. Actualizar Paginaci√≥n
  function actualizarPaginacion() {
    const paginacion = document.getElementById('paginacion');
    const paginaActualSpan = document.getElementById('paginaActual');
    const totalPaginasSpan = document.getElementById('totalPaginas');
    const btnAnterior = document.getElementById('btnAnterior');
    const btnSiguiente = document.getElementById('btnSiguiente');
    
    let mensajesFiltrados = [...mensajes];
    if (busqueda) {
      const busquedaLower = busqueda.toLowerCase();
      mensajesFiltrados = mensajesFiltrados.filter(m => 
        m.texto.toLowerCase().includes(busquedaLower)
      );
    }
    
    const totalPaginas = Math.ceil(mensajesFiltrados.length / limitePorPagina);
    
    if (totalPaginas > 1) {
      paginacion.style.display = 'flex';
      paginaActualSpan.textContent = paginaActual;
      totalPaginasSpan.textContent = totalPaginas;
      
      btnAnterior.disabled = paginaActual === 1;
      btnSiguiente.disabled = paginaActual === totalPaginas;
      
      btnAnterior.style.opacity = btnAnterior.disabled ? '0.5' : '1';
      btnSiguiente.style.opacity = btnSiguiente.disabled ? '0.5' : '1';
    } else {
      paginacion.style.display = 'none';
    }
  }
  
  // Funci√≥n para actualizar contadores de caracteres
  function actualizarContadores() {
    // Contador para crear
    const inputCrear = document.getElementById('inputCrearMensaje');
    const contadorCrear = document.getElementById('contadorCrear');
    if (inputCrear && contadorCrear) {
      inputCrear.addEventListener('input', function() {
        const length = this.value.length;
        contadorCrear.textContent = `${length}/50`;
        contadorCrear.style.color = length >= 50 ? '#ef4444' : '#6b7280';
      });
    }
    
    // Contador para editar
    const inputEditar = document.getElementById('inputEditarMensaje');
    const contadorEditar = document.getElementById('contadorEditar');
    if (inputEditar && contadorEditar) {
      inputEditar.addEventListener('input', function() {
        const length = this.value.length;
        contadorEditar.textContent = `${length}/50`;
        contadorEditar.style.color = length >= 50 ? '#ef4444' : '#6b7280';
      });
    }
  }
  
  // 5. Crear Nuevo Mensaje
  async function crearMensaje() {
    const texto = document.getElementById('inputCrearMensaje').value.trim();
    
    if (!texto) {
      alert("‚ùå Por favor escribe un mensaje");
      return;
    }
    
    if (texto.length > 50) {
      alert("‚ùå El mensaje no puede tener m√°s de 50 caracteres");
      return;
    }
    
    // Obtener token de hCaptcha
    let tokenCaptcha;
    if (window.hcaptcha) {
      tokenCaptcha = hcaptcha.getResponse();
    } else {
      tokenCaptcha = document.querySelector('[name="h-captcha-response"]')?.value;
    }
    
    if (!tokenCaptcha) {
      alert("‚ö†Ô∏è Por favor completa el captcha");
      return;
    }
    
    const btnCrear = document.getElementById('btnCrear');
    const textoOriginal = btnCrear.textContent;
    btnCrear.disabled = true;
    btnCrear.textContent = 'Enviando...';
    btnCrear.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
    
    try {
      const response = await fetch(`${BACKEND_URL}/api/guardar`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ 
          texto: texto, 
          hcaptcha: tokenCaptcha 
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        mostrarResultado('success', `
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div style="
              background: #10b981;
              color: white;
              width: 30px;
              height: 30px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            ">‚úì</div>
            <strong style="font-size: 1.1rem; color: #065f46;">‚úÖ ¬°Mensaje guardado!</strong>
          </div>
          <div style="color: #065f46; margin-left: 40px;">
            <strong>Fecha:</strong> ${new Date(data.fecha).toLocaleString()}<br>
            <strong>Mensaje:</strong> "${data.texto}"
          </div>
        `, 'resultadoCrear');
        
        // Limpiar formulario
        document.getElementById('inputCrearMensaje').value = '';
        document.getElementById('contadorCrear').textContent = '0/50';
        
        // Resetear captcha
        if (window.hcaptcha) {
          hcaptcha.reset();
        }
        
        // Recargar lista despu√©s de 1 segundo
        setTimeout(() => {
          cargarMensajes();
          verificarSalud();
        }, 1000);
      } else {
        throw new Error(data.message || data.error || 'Error desconocido');
      }
    } catch (err) {
      console.error('Error creando mensaje:', err);
      mostrarResultado('error', `
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="
            background: #ef4444;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
          ">‚úó</div>
          <strong style="color: #991b1b;">‚ùå Error al guardar</strong>
        </div>
        <div style="color: #991b1b; margin-left: 40px; margin-top: 5px;">
          ${err.message}
        </div>
      `, 'resultadoCrear');
    } finally {
      btnCrear.disabled = false;
      btnCrear.textContent = textoOriginal;
      btnCrear.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    }
  }
  
  // 6. Iniciar Edici√≥n de Mensaje
  function iniciarEdicion(id, textoOriginal) {
    mensajeAEditar = { id, textoOriginal };
    
    document.getElementById('formularioEdicion').style.display = 'block';
    document.getElementById('mensajeOriginal').textContent = textoOriginal;
    document.getElementById('inputEditarMensaje').value = textoOriginal;
    
    // Actualizar contador
    const contadorEditar = document.getElementById('contadorEditar');
    if (contadorEditar) {
      contadorEditar.textContent = `${textoOriginal.length}/50`;
      contadorEditar.style.color = textoOriginal.length >= 50 ? '#ef4444' : '#6b7280';
    }
    
    document.getElementById('inputEditarMensaje').focus();
    
    // Desplazar al formulario de edici√≥n
    document.getElementById('formularioEdicion').scrollIntoView({ 
      behavior: 'smooth',
      block: 'start'
    });
  }
  
  // 7. Actualizar Mensaje - CORREGIDO (URL CORRECTA)
  async function actualizarMensaje() {
    const nuevoTexto = document.getElementById('inputEditarMensaje').value.trim();
    
    if (!nuevoTexto) {
      alert("‚ùå Por favor escribe el nuevo mensaje");
      return;
    }
    
    if (nuevoTexto.length > 50) {
      alert("‚ùå El mensaje no puede tener m√°s de 50 caracteres");
      return;
    }
    
    if (!mensajeAEditar) {
      return;
    }
    
    const btnActualizar = document.getElementById('btnActualizar');
    const textoOriginal = btnActualizar.textContent;
    btnActualizar.disabled = true;
    btnActualizar.textContent = 'Actualizando...';
    
    try {
      // ‚úÖ USAR LA URL CORRECTA PARA EDITAR: /api/mensajes/:id con m√©todo PUT
      const url = `${BACKEND_URL}/api/mensajes/${mensajeAEditar.id}`;
      
      console.log('üîÑ Actualizando mensaje:', {
        id: mensajeAEditar.id,
        texto: nuevoTexto,
        url: url
      });
      
      const response = await fetch(url, {
        method: 'PUT',  // ‚úÖ USAR M√âTODO PUT
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ 
          texto: nuevoTexto 
        })
      });
      
      const data = await response.json();
      console.log('üì• Respuesta del servidor:', data);
      
      if (data.success) {
        mostrarResultado('success', `
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div style="
              background: #10b981;
              color: white;
              width: 30px;
              height: 30px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            ">‚úì</div>
            <strong style="font-size: 1.1rem; color: #065f46;">‚úÖ ¬°Mensaje actualizado!</strong>
            </div>
            <div style="color: #065f46; margin-left: 40px;">
              <strong>Mensaje actualizado:</strong> "${data.mensaje?.texto || nuevoTexto}"
            </div>
        `, 'resultadoEditar');
        
        // Ocultar formulario despu√©s de 2 segundos
        setTimeout(() => {
          cancelarEdicion();
          cargarMensajes();
          verificarSalud();
        }, 2000);
      } else {
        throw new Error(data.message || data.error || 'Error desconocido');
      }
    } catch (err) {
      console.error('Error actualizando mensaje:', err);
      mostrarResultado('error', `
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="
            background: #ef4444;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
          ">‚úó</div>
          <strong style="color: #991b1b;">‚ùå Error al actualizar</strong>
        </div>
        <div style="color: #991b1b; margin-left: 40px; margin-top: 5px;">
          ${err.message}
        </div>
      `, 'resultadoEditar');
    } finally {
      btnActualizar.disabled = false;
      btnActualizar.textContent = textoOriginal;
    }
  }
  
  // 8. Cancelar Edici√≥n
  function cancelarEdicion() {
    mensajeAEditar = null;
    document.getElementById('formularioEdicion').style.display = 'none';
    document.getElementById('resultadoEditar').style.display = 'none';
  }
  
  // 9. Eliminar Mensaje - CORREGIDO (URL CORRECTA)
  async function eliminarMensaje(id) {
    try {
      console.log('üóëÔ∏è Eliminando mensaje ID:', id);
      
      // ‚úÖ USAR LA URL CORRECTA PARA ELIMINAR: /api/mensajes/:id con m√©todo DELETE
      const url = `${BACKEND_URL}/api/mensajes/${id}`;
      
      console.log('üîÑ Intentando eliminar en:', url);
      
      const response = await fetch(url, {
        method: 'DELETE',
        headers: { 
          'Accept': 'application/json'
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        mostrarResultado('success', `
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <div style="
              background: #10b981;
              color: white;
              width: 30px;
              height: 30px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            ">‚úì</div>
            <strong style="font-size: 1.1rem; color: #065f46;">‚úÖ ¬°Mensaje eliminado!</strong>
          </div>
          <div style="color: #065f46; margin-left: 40px;">
            El mensaje ha sido eliminado correctamente.
          </div>
        `, 'resultadoCrear');
        
        // Recargar lista despu√©s de 1 segundo
        setTimeout(() => {
          cargarMensajes();
          verificarSalud();
        }, 1000);
        
      } else {
        throw new Error(data.message || 'Error desconocido');
      }
      
    } catch (err) {
      console.error('Error eliminando mensaje:', err);
      mostrarResultado('error', `
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="
            background: #ef4444;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
          ">‚úó</div>
          <strong style="color: #991b1b;">‚ùå Error al eliminar</strong>
        </div>
        <div style="color: #991b1b; margin-left: 40px; margin-top: 5px;">
          ${err.message}
        </div>
      `, 'resultadoCrear');
    } finally {
      mensajeAEliminar = null;
    }
  }
  
  // 10. Mostrar Modal de Confirmaci√≥n
  function mostrarModalConfirmacion(id, texto) {
    mensajeAEliminar = id;
    
    const modal = document.getElementById('modalConfirmacion');
    const titulo = document.getElementById('modalTitulo');
    const mensaje = document.getElementById('modalMensaje');
    
    titulo.textContent = '¬øEliminar Mensaje?';
    mensaje.innerHTML = `
      Est√°s a punto de eliminar este mensaje<br><br>
      <div style="
        background: #fee2e2;
        padding: 10px;
        border-radius: 6px;
        border-left: 3px solid #ef4444;
        margin: 10px 0;
        font-size: 0.9rem;
      ">
        "${texto.substring(0, 100)}${texto.length > 100 ? '...' : ''}"
      </div>
      <span style="color: #ef4444; font-weight: 600; font-size: 0.9rem;">Esta acci√≥n no se puede deshacer.</span>
    `;
    
    modal.style.display = 'flex';
  }
  
  // 11. Ocultar Modal
  function ocultarModal() {
    const modal = document.getElementById('modalConfirmacion');
    modal.style.display = 'none';
  }
  
  // 12. Mostrar Resultado
  function mostrarResultado(tipo, contenido, elementoId) {
    const elemento = document.getElementById(elementoId);
    
    if (tipo === 'success') {
      elemento.style.background = 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)';
      elemento.style.borderLeft = '4px solid #10b981';
    } else {
      elemento.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
      elemento.style.borderLeft = '4px solid #ef4444';
    }
    
    elemento.innerHTML = contenido;
    elemento.style.display = 'block';
    
    // Auto-ocultar despu√©s de 5 segundos (excepto para √©xito r√°pido)
    if (tipo === 'success') {
      setTimeout(() => {
        elemento.style.display = 'none';
      }, 5000);
    }
  }
  
  // ====================
  // EVENT LISTENERS
  // ====================
  
  document.addEventListener('DOMContentLoaded', function() {
    // Cargar hCaptcha din√°micamente
    const script = document.createElement('script');
    script.src = 'https://js.hcaptcha.com/1/api.js';
    script.async = true;
    document.head.appendChild(script);
    
    // Inicializar contadores
    actualizarContadores();
    
    // Inicializar
    verificarSalud();
    cargarMensajes();
    
    // Event Listeners
    
    // 1. Crear mensaje
    document.getElementById('btnCrear').addEventListener('click', crearMensaje);
    
    // 2. Actualizar mensaje
    document.getElementById('btnActualizar').addEventListener('click', actualizarMensaje);
    
    // 3. Cancelar edici√≥n
    document.getElementById('btnCancelarEdicion').addEventListener('click', cancelarEdicion);
    
    // 4. Recargar lista
    document.getElementById('btnRecargar').addEventListener('click', function() {
      paginaActual = 1;
      cargarMensajes();
    });
    
    // 5. B√∫squeda
    const inputBuscar = document.getElementById('inputBuscar');
    inputBuscar.addEventListener('input', function(e) {
      clearTimeout(this.timer);
      this.timer = setTimeout(() => {
        busqueda = e.target.value;
        paginaActual = 1;
        actualizarListaMensajes();
        actualizarPaginacion();
      }, 500);
    });
    
    // 6. Orden
    document.getElementById('selectOrden').addEventListener('change', function(e) {
      orden = e.target.value;
      paginaActual = 1;
      actualizarListaMensajes();
      actualizarPaginacion();
    });
    
    // 7. L√≠mite por p√°gina
    document.getElementById('selectLimite').addEventListener('change', function(e) {
      limitePorPagina = parseInt(e.target.value);
      paginaActual = 1;
      actualizarListaMensajes();
      actualizarPaginacion();
    });
    
    // 8. Paginaci√≥n
    document.getElementById('btnAnterior').addEventListener('click', function() {
      if (paginaActual > 1) {
        paginaActual--;
        actualizarListaMensajes();
        actualizarPaginacion();
      }
    });
    
    document.getElementById('btnSiguiente').addEventListener('click', function() {
      paginaActual++;
      actualizarListaMensajes();
      actualizarPaginacion();
    });
    
    // 9. Modal de confirmaci√≥n
    document.getElementById('btnModalConfirmar').addEventListener('click', function() {
      if (mensajeAEliminar) {
        eliminarMensaje(mensajeAEliminar);
      }
      ocultarModal();
    });
    
    document.getElementById('btnModalCancelar').addEventListener('click', ocultarModal);
    
    // 10. Enter en inputs
    document.getElementById('inputCrearMensaje').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        crearMensaje();
      }
    });
    
    document.getElementById('inputEditarMensaje').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        actualizarMensaje();
      }
    });
    
    // 11. Cerrar modal con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        ocultarModal();
      }
    });
    
    // 12. Click fuera del modal para cerrar
    document.getElementById('modalConfirmacion').addEventListener('click', function(e) {
      if (e.target === this) {
        ocultarModal();
      }
    });
    
    // 13. Hacer responsive
    function hacerResponsive() {
      const listaMensajes = document.getElementById('listaMensajes');
      if (window.innerWidth < 768) {
        if (listaMensajes) {
          listaMensajes.style.gridTemplateColumns = '1fr';
        }
      } else {
        if (listaMensajes) {
          listaMensajes.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
        }
      }
    }
    
    window.addEventListener('resize', hacerResponsive);
    hacerResponsive();
  });
</script>