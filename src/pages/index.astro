---
// src/pages/index.astro
import Layout from '../layout/Layout.astro';
---

<Layout>
  <div style="
    min-height: 100vh;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  ">
    
    <div style="
      max-width: 450px;
      width: 100%;
      background: white;
      padding: 40px;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
    ">
      
      <div style="margin-bottom: 30px;">
        <h1 style="font-size: 2.2rem; color: #2d3748; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
          Hola Astro <span style="color: #7c3aed;">ğŸ’œ</span>
        </h1>
        <p style="color: #718096; font-size: 1rem;">
          Escribe un mensaje para enviarlo a <br><strong>PostgreSQL en Railway</strong>
        </p>
      </div>

      <div style="text-align: left; margin-bottom: 25px;">
        <label for="miCampoUnico" style="display: block; font-weight: 600; color: #4a5568; margin-bottom: 8px; margin-left: 4px;">
          ğŸ“ Tu mensaje personal
        </label>
        <input 
          type="text" 
          id="miCampoUnico"
          placeholder="Â¿QuÃ© tienes en mente?..."
          style="
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
          "
        >
      </div>

      <div style="margin-bottom: 25px; display: flex; justify-content: center; flex-direction: column; align-items: center;">
        <div class="h-captcha" data-sitekey="10000000-ffff-ffff-ffff-000000000001"></div>
        <small style="color: #a0aec0; margin-top: 8px;">ğŸ›¡ï¸ VerificaciÃ³n de seguridad</small>
      </div>

      <button 
        id="botonEnviar"
        style="
          width: 100%;
          background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
          color: white;
          padding: 18px;
          border: none;
          border-radius: 14px;
          font-size: 1.1rem;
          font-weight: 700;
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
          box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        "
      >
        ğŸš€ Enviar Mensaje
      </button>

      <div id="resultado" style="
        margin-top: 25px;
        padding: 15px;
        border-radius: 12px;
        display: none;
        font-size: 0.95rem;
        line-height: 1.5;
      "></div>

      <div style="
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #edf2f7;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: #718096;
      ">
        <span id="estadoTexto">â³ Verificando conexiÃ³n...</span>
        <a href="https://violet-virgo-production.up.railway.app/api/mensajes" target="_blank" style="color: #6366f1; text-decoration: none; font-weight: 600;">Ver historial â†’</a>
      </div>

    </div>
  </div>

  <script>
    const BACKEND_URL = 'https://violet-virgo-production.up.railway.app';
    
    // Cargar hCaptcha
    const script = document.createElement('script');
    script.src = 'https://js.hcaptcha.com/1/api.js';
    script.async = true;
    document.head.appendChild(script);
    
    // Verificar ConexiÃ³n
    async function verificarConexion() {
      const statusSpan = document.getElementById('estadoTexto');
      try {
        const res = await fetch(`${BACKEND_URL}/health`);
        const data = await res.json();
        if (data.status === 'âœ… OK') {
          statusSpan.innerHTML = 'ğŸŸ¢ Sistema Online';
          statusSpan.style.color = '#10b981';
        }
      } catch (e) {
        statusSpan.innerHTML = 'ğŸ”´ Sistema Offline';
        statusSpan.style.color = '#ef4444';
      }
    }

    document.addEventListener('DOMContentLoaded', verificarConexion);

    // AnimaciÃ³n de input
    const input = document.getElementById('miCampoUnico');
    input.addEventListener('focus', () => input.style.borderColor = '#6366f1');
    input.addEventListener('blur', () => input.style.borderColor = '#e2e8f0');

    // LÃ³gica de EnvÃ­o
    document.getElementById('botonEnviar').addEventListener('click', async function() {
      const resDiv = document.getElementById('resultado');
      const texto = input.value.trim();
      const token = document.querySelector('[name="h-captcha-response"]')?.value;

      if (!texto || !token) {
        alert("Â¡No olvides escribir tu mensaje y completar el captcha!");
        return;
      }

      // Estilo de carga
      this.disabled = true;
      this.style.opacity = '0.7';
      this.textContent = 'Guardando...';

      try {
        const response = await fetch(`${BACKEND_URL}/api/guardar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ texto, hcaptcha: token })
        });

        const data = await response.json();

        resDiv.style.display = 'block';
        if (data.success) {
          resDiv.style.background = '#f0fff4';
          resDiv.style.color = '#22543d';
          resDiv.style.border = '1px solid #c6f6d5';
          resDiv.innerHTML = `<strong>âœ¨ Â¡Logrado!</strong><br>Mensaje guardado con ID #${data.id}`;
          input.value = '';
          if (window.hcaptcha) window.hcaptcha.reset();
        } else {
          throw new Error(data.message || 'Error al guardar');
        }
      } catch (err) {
        resDiv.style.display = 'block';
        resDiv.style.background = '#fff5f5';
        resDiv.style.color = '#c53030';
        resDiv.style.border = '1px solid #fed7d7';
        resDiv.innerHTML = `<strong>âŒ Error:</strong> ${err.message}`;
      } finally {
        this.disabled = false;
        this.style.opacity = '1';
        this.textContent = 'ğŸš€ Enviar Mensaje';
      }
    });
  </script>
</Layout>