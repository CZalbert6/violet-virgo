// src/pages/carrusel.astro
import Layout from '../layout/Layout.astro';
---

<Layout>
  <div style="
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    font-family: Arial, sans-serif;
  ">
    <!-- Breadcrumbs -->
    <nav style="margin-bottom: 30px;">
      <div style="
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: #666;
      ">
        <a href="/violet-virgo" style="color: #3b82f6; text-decoration: none;">
          <span>üè†</span>
          <span>Inicio</span>
        </a>
        <span style="color: #94a3b8;">‚Ä∫</span>
        <span style="color: #64748b;">Carrusel de Im√°genes</span>
      </div>
    </nav>

    <!-- T√≠tulo -->
    <h1 style="
      color: #333;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.2rem;
    ">
      üñºÔ∏è Carrusel de Im√°genes
    </h1>
    <p style="color: #666; text-align: center; margin-bottom: 40px;">
      Sube im√°genes desde tu dispositivo a PostgreSQL (Base64)
    </p>

    <!-- Contenedor principal -->
    <div style="display: grid; grid-template-columns: 1fr; gap: 40px;">
      
      <!-- Secci√≥n 1: Carrusel -->
      <div>
        <h2 style="color: #333; margin-bottom: 20px; font-size: 1.5rem;">
          üì∏ Vista Previa del Carrusel
        </h2>
        
        <!-- Carrusel -->
        <div id="carruselContainer" style="
          width: 100%;
          height: 400px;
          position: relative;
          border-radius: 15px;
          overflow: hidden;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
          background: linear-gradient(135deg, #f8fafc, #e2e8f0);
          display: flex;
          align-items: center;
          justify-content: center;
          margin-bottom: 20px;
        ">
          <!-- Mensaje cuando no hay im√°genes -->
          <div id="sinImagenes" style="text-align: center; color: #94a3b8; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
            <p>No hay im√°genes en el carrusel</p>
            <p style="font-size: 0.9rem; margin-top: 10px;">Sube tu primera imagen abajo</p>
          </div>
          
          <!-- Imagen actual (se muestra din√°micamente) -->
          <div id="imagenActual" style="
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
          "></div>
        </div>

        <!-- Controles del carrusel -->
        <div style="
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 20px;
          margin-bottom: 20px;
        ">
          <button 
            id="btnAnterior"
            style="
              background: #3b82f6;
              color: white;
              border: none;
              width: 50px;
              height: 50px;
              border-radius: 50%;
              font-size: 20px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.3s;
              box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            "
            onmouseenter="this.style.background='#2563eb'; this.style.transform='scale(1.1)';"
            onmouseleave="this.style.background='#3b82f6'; this.style.transform='scale(1)';"
            disabled
          >
            ‚óÄ
          </button>
          
          <div style="text-align: center; min-width: 100px;">
            <div id="contador" style="
              font-size: 1.2rem;
              font-weight: bold;
              color: #333;
              margin-bottom: 5px;
            ">0 / 0</div>
            <div id="nombreImagen" style="
              font-size: 0.9rem;
              color: #666;
              max-width: 200px;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            "></div>
          </div>
          
          <button 
            id="btnSiguiente"
            style="
              background: #3b82f6;
              color: white;
              border: none;
              width: 50px;
              height: 50px;
              border-radius: 50%;
              font-size: 20px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.3s;
              box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            "
            onmouseenter="this.style.background='#2563eb'; this.style.transform='scale(1.1)';"
            onmouseleave="this.style.background='#3b82f6'; this.style.transform='scale(1)';"
            disabled
          >
            ‚ñ∂
          </button>
        </div>

        <!-- Miniaturas -->
        <div id="miniaturasContainer" style="
          display: flex;
          gap: 10px;
          padding: 10px;
          overflow-x: auto;
          background: #f8fafc;
          border-radius: 10px;
          min-height: 80px;
        "></div>
      </div>

      <!-- Secci√≥n 2: Subir im√°genes DESDE DISPOSITIVO -->
      <div>
        <h2 style="color: #333; margin-bottom: 20px; font-size: 1.5rem;">
          üì§ Subir Imagen desde tu Dispositivo
        </h2>
        
        <div style="
          background: white;
          border-radius: 15px;
          padding: 25px;
          box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
          border: 1px solid #e2e8f0;
        ">
          <!-- Selector de archivos -->
          <div style="margin-bottom: 25px;">
            <label style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #555;
            ">
              üìÅ Selecciona una imagen *
            </label>
            
            <div style="
              border: 2px dashed #3b82f6;
              border-radius: 10px;
              padding: 40px 20px;
              text-align: center;
              background: #f0f9ff;
              cursor: pointer;
              transition: all 0.3s;
            "
            id="dropZone"
            onmouseenter="this.style.background='#e0f2fe'; this.style.borderColor='#2563eb';"
            onmouseleave="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6';">
              <input 
                type="file" 
                id="inputArchivo"
                accept="image/*"
                style="display: none;"
              >
              
              <div style="font-size: 48px; margin-bottom: 15px; color: #3b82f6;">
                üì§
              </div>
              <div style="font-weight: 600; color: #1e40af; margin-bottom: 10px;">
                Haz clic o arrastra una imagen aqu√≠
              </div>
              <div style="color: #475569; font-size: 0.9rem; margin-bottom: 15px;">
                Formatos aceptados: JPG, PNG, GIF, WebP
              </div>
              <div style="color: #64748b; font-size: 0.85rem;">
                M√°ximo 2MB por imagen
              </div>
            </div>
            
            <!-- Vista previa de la imagen seleccionada -->
            <div id="vistaPreviaContainer" style="
              margin-top: 20px;
              display: none;
              text-align: center;
            ">
              <div style="font-weight: 600; color: #555; margin-bottom: 10px;">
                üìã Vista previa:
              </div>
              <div id="vistaPrevia" style="
                max-width: 200px;
                max-height: 200px;
                margin: 0 auto;
                border-radius: 8px;
                overflow: hidden;
                border: 2px solid #e2e8f0;
              "></div>
              <div id="infoArchivo" style="
                margin-top: 10px;
                color: #666;
                font-size: 0.9rem;
              "></div>
            </div>
          </div>
          
          <!-- Campo para nombre -->
          <div style="margin-bottom: 25px;">
            <label style="
              display: block;
              margin-bottom: 8px;
              font-weight: 600;
              color: #555;
            ">
              üìù Nombre para la imagen *
            </label>
            <input 
              type="text" 
              id="inputNombre"
              placeholder="Ej: Mi foto de vacaciones"
              style="
                width: 100%;
                padding: 12px 15px;
                border: 2px solid #e2e8f0;
                border-radius: 8px;
                font-size: 16px;
                transition: all 0.3s;
              "
              required
              onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
              onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';"
            >
            <div style="font-size: 12px; color: #666; margin-top: 5px;">
              Nombre descriptivo para identificar la imagen
            </div>
          </div>
          
          <!-- Bot√≥n de subir -->
          <button 
            id="btnSubir"
            style="
              background: linear-gradient(135deg, #10b981, #059669);
              color: white;
              padding: 15px 30px;
              border: none;
              border-radius: 8px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              width: 100%;
              transition: all 0.3s;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 10px;
            "
            onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(16, 185, 129, 0.4)';"
            onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
            disabled
          >
            <span>üì§</span>
            <span>Subir Imagen a PostgreSQL</span>
          </button>
          
          <!-- Barra de progreso -->
          <div id="barraProgreso" style="
            margin-top: 20px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            display: none;
          ">
            <div id="progreso" style="
              height: 100%;
              background: #3b82f6;
              width: 0%;
              transition: width 0.3s;
            "></div>
          </div>
          
          <!-- Mensaje de resultado -->
          <div id="mensajeResultado" style="
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
            text-align: center;
            font-weight: 600;
          "></div>
        </div>
        
        <!-- Lista de im√°genes existentes -->
        <div style="margin-top: 30px;">
          <h3 style="color: #333; margin-bottom: 15px; font-size: 1.2rem;">
            üóÇÔ∏è Im√°genes en la Base de Datos
          </h3>
          <div id="listaImagenes" style="
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
          ">
            <div style="text-align: center; color: #94a3b8; padding: 40px;">
              <div style="font-size: 32px; margin-bottom: 10px;">üìã</div>
              <p>Cargando im√°genes...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====================
    // CONFIGURACI√ìN
    // ====================
    const BACKEND_URL = 'https://violet-virgo-production.up.railway.app';
    let imagenes = [];
    let imagenActualIndex = 0;
    let archivoSeleccionado = null;
    let imagenBase64 = '';
    let tipoMime = '';
    
    // ====================
    // FUNCI√ìN DE PRUEBA R√ÅPIDA (para diagn√≥stico)
    // ====================
    window.probarConexion = async function() {
      console.log('üß™ Probando conexi√≥n con el backend...');
      
      try {
        // 1. Probar GET /api/carrusel
        console.log('1Ô∏è‚É£ Probando GET /api/carrusel...');
        const getRespuesta = await fetch(`${BACKEND_URL}/api/carrusel`);
        console.log('üì§ GET Status:', getRespuesta.status, getRespuesta.statusText);
        
        if (!getRespuesta.ok) {
          const errorText = await getRespuesta.text();
          console.error('‚ùå GET Error:', errorText);
          mostrarMensaje(`‚ùå GET Error: ${getRespuesta.status} ${errorText}`, 'error');
          return;
        }
        
        const getDatos = await getRespuesta.json();
        console.log('‚úÖ GET funcionando:', getDatos);
        
        // 2. Probar POST con imagen peque√±a de prueba
        console.log('2Ô∏è‚É£ Probando POST /api/carrusel...');
        const imagenTest = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
        
        const datosPrueba = {
          nombre: 'test_' + Date.now(),
          imagen_base64: imagenTest,
          tipo_mime: 'image/png'
        };
        
        console.log('üì§ Enviando datos de prueba:', datosPrueba);
        
        const postRespuesta = await fetch(`${BACKEND_URL}/api/carrusel`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(datosPrueba)
        });
        
        console.log('üì• POST Status:', postRespuesta.status, postRespuesta.statusText);
        console.log('üì• POST Headers:', Object.fromEntries(postRespuesta.headers.entries()));
        
        if (!postRespuesta.ok) {
          const errorText = await postRespuesta.text();
          console.error('‚ùå POST Error texto completo:', errorText);
          try {
            const errorJson = JSON.parse(errorText);
            console.error('‚ùå POST Error JSON:', errorJson);
            mostrarMensaje(`‚ùå POST Error ${postRespuesta.status}: ${errorJson.error || errorJson.message || errorText}`, 'error');
          } catch {
            mostrarMensaje(`‚ùå POST Error ${postRespuesta.status}: ${errorText}`, 'error');
          }
          return;
        }
        
        const postDatos = await postRespuesta.json();
        console.log('‚úÖ POST funcionando:', postDatos);
        mostrarMensaje('‚úÖ ¬°Conexi√≥n y env√≠o funcionan correctamente!', 'success');
        
        // 3. Recargar im√°genes para mostrar el test
        setTimeout(() => {
          cargarImagenes();
        }, 1000);
        
      } catch (error) {
        console.error('‚ùå Error en prueba:', error);
        console.error('‚ùå Stack trace:', error.stack);
        mostrarMensaje(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
      }
    };
    
    // ====================
    // FUNCIONES PRINCIPALES
    // ====================
    
    // 1. Cargar im√°genes desde el backend - MEJORADA
    async function cargarImagenes() {
      try {
        console.log('üîÑ Cargando im√°genes...');
        const respuesta = await fetch(`${BACKEND_URL}/api/carrusel`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });
        
        // Verificar si la respuesta es OK
        if (!respuesta.ok) {
          const errorText = await respuesta.text();
          throw new Error(`HTTP ${respuesta.status}: ${errorText}`);
        }
        
        const datos = await respuesta.json();
        console.log('üì• Respuesta del servidor:', datos);
        
        if (datos.success) {
          imagenes = datos.imagenes || [];
          console.log(`‚úÖ ${imagenes.length} im√°genes cargadas`);
          
          if (imagenes.length > 0) {
            // Para cada imagen, cargar el Base64
            await cargarImagenesCompletas();
            mostrarCarrusel();
            mostrarMiniaturas();
            mostrarListaImagenes();
          } else {
            mostrarCarruselVacio();
          }
        } else {
          console.error('‚ùå Error del servidor:', datos);
          mostrarMensaje(`Error: ${datos.message || datos.error || 'Error desconocido'}`, 'error');
        }
      } catch (error) {
        console.error('‚ùå Error cargando im√°genes:', error);
        
        // Mensaje amigable para el usuario
        if (error.message.includes('Failed to fetch')) {
          mostrarError('No se pudo conectar al servidor. Verifica tu conexi√≥n a internet.');
        } else if (error.message.includes('500')) {
          mostrarError('Error interno del servidor. El servidor est√° reparando las tablas autom√°ticamente. Intenta de nuevo en 30 segundos.');
          
          // Intentar nuevamente despu√©s de 5 segundos
          setTimeout(() => {
            console.log('üîÑ Reintentando carga...');
            cargarImagenes();
          }, 5000);
        } else {
          mostrarError('Error: ' + error.message);
        }
      }
    }
    
    // 2. Cargar im√°genes completas con Base64
    async function cargarImagenesCompletas() {
      const nuevasImagenes = [];
      
      for (const imagen of imagenes) {
        try {
          const respuesta = await fetch(`${BACKEND_URL}/api/carrusel/${imagen.id}`);
          
          if (!respuesta.ok) {
            console.warn(`‚ö†Ô∏è Error cargando imagen ${imagen.id}:`, respuesta.status);
            continue;
          }
          
          const datos = await respuesta.json();
          
          if (datos.success && datos.imagen.imagen_base64) {
            // Crear URL temporal para la imagen
            imagen.dataUrl = datos.imagen.imagen_base64;
            nuevasImagenes.push(imagen);
          }
        } catch (error) {
          console.error(`Error cargando imagen ${imagen.id}:`, error);
        }
      }
      
      imagenes = nuevasImagenes;
    }
    
    // 3. Mostrar carrusel vac√≠o
    function mostrarCarruselVacio() {
      document.getElementById('sinImagenes').style.display = 'block';
      document.getElementById('imagenActual').style.display = 'none';
      document.getElementById('contador').textContent = '0 / 0';
      document.getElementById('nombreImagen').textContent = '';
      
      // Deshabilitar controles
      document.getElementById('btnAnterior').disabled = true;
      document.getElementById('btnSiguiente').disabled = true;
      document.getElementById('btnAnterior').style.background = '#cbd5e1';
      document.getElementById('btnSiguiente').style.background = '#cbd5e1';
      
      // Limpiar miniaturas
      document.getElementById('miniaturasContainer').innerHTML = '';
      
      // Actualizar lista
      document.getElementById('listaImagenes').innerHTML = `
        <div style="text-align: center; color: #94a3b8; padding: 40px;">
          <div style="font-size: 32px; margin-bottom: 10px;">üîÑ</div>
          <p>No hay im√°genes en la base de datos</p>
          <p style="font-size: 0.9rem; margin-top: 10px;">Sube tu primera imagen arriba</p>
        </div>
      `;
    }
    
    // 4. Mostrar imagen en el carrusel
    function mostrarCarrusel() {
      if (imagenes.length === 0) {
        mostrarCarruselVacio();
        return;
      }
      
      const imagen = imagenes[imagenActualIndex];
      
      // Ocultar mensaje de vac√≠o
      document.getElementById('sinImagenes').style.display = 'none';
      document.getElementById('imagenActual').style.display = 'block';
      
      // Mostrar imagen desde Base64
      document.getElementById('imagenActual').innerHTML = `
        <div style="
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          background: white;
        ">
          <img 
            src="${imagen.dataUrl || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f1f5f9"/><text x="50" y="50" font-family="Arial" font-size="10" text-anchor="middle" fill="%2394a3b8">Imagen no disponible</text></svg>'}" 
            alt="${imagen.nombre}"
            style="
              max-width: 90%;
              max-height: 90%;
              object-fit: contain;
              border-radius: 10px;
              box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            "
          >
        </div>
        <div style="
          position: absolute;
          bottom: 0;
          left: 0;
          right: 0;
          background: rgba(0,0,0,0.7);
          color: white;
          padding: 15px;
          text-align: center;
        ">
          <div style="font-weight: 600; margin-bottom: 5px;">${imagen.nombre}</div>
          <div style="font-size: 0.8rem; opacity: 0.8;">
            ${imagen.tamano ? `Tama√±o: ${(imagen.tamano / 1024).toFixed(2)} KB` : ''}
            ${imagen.fecha ? ` | Subida: ${imagen.fecha}` : ''}
          </div>
        </div>
      `;
      
      // Actualizar contador
      document.getElementById('contador').textContent = `${imagenActualIndex + 1} / ${imagenes.length}`;
      document.getElementById('nombreImagen').textContent = imagen.nombre;
      
      // Habilitar/deshabilitar controles
      const btnAnterior = document.getElementById('btnAnterior');
      const btnSiguiente = document.getElementById('btnSiguiente');
      
      btnAnterior.disabled = imagenActualIndex === 0;
      btnSiguiente.disabled = imagenActualIndex === imagenes.length - 1;
      
      btnAnterior.style.background = btnAnterior.disabled ? '#cbd5e1' : '#3b82f6';
      btnSiguiente.style.background = btnSiguiente.disabled ? '#cbd5e1' : '#3b82f6';
    }
    
    // 5. Mostrar miniaturas
    function mostrarMiniaturas() {
      const container = document.getElementById('miniaturasContainer');
      container.innerHTML = '';
      
      imagenes.forEach((imagen, index) => {
        const miniatura = document.createElement('div');
        miniatura.style.cssText = `
          width: 70px;
          height: 70px;
          border-radius: 8px;
          overflow: hidden;
          cursor: pointer;
          opacity: ${index === imagenActualIndex ? '1' : '0.6'};
          border: ${index === imagenActualIndex ? '3px solid #3b82f6' : '1px solid #e2e8f0'};
          flex-shrink: 0;
          transition: all 0.3s;
          background: white;
        `;
        
        miniatura.innerHTML = `
          <img 
            src="${imagen.dataUrl || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f1f5f9"/><text x="50" y="50" font-family="Arial" font-size="10" text-anchor="middle" fill="%2394a3b8">?</text></svg>'}" 
            alt="Miniatura"
            style="width: 100%; height: 100%; object-fit: cover;"
          >
        `;
        
        miniatura.onclick = () => {
          imagenActualIndex = index;
          mostrarCarrusel();
          mostrarMiniaturas();
        };
        
        miniatura.onmouseenter = () => {
          if (index !== imagenActualIndex) {
            miniatura.style.opacity = '0.8';
            miniatura.style.transform = 'scale(1.05)';
          }
        };
        
        miniatura.onmouseleave = () => {
          if (index !== imagenActualIndex) {
            miniatura.style.opacity = '0.6';
            miniatura.style.transform = 'scale(1)';
          }
        };
        
        container.appendChild(miniatura);
      });
    }
    
    // 6. Mostrar lista de im√°genes
    function mostrarListaImagenes() {
      const container = document.getElementById('listaImagenes');
      
      if (imagenes.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; color: #94a3b8; padding: 40px;">
            <div style="font-size: 32px; margin-bottom: 10px;">üì≠</div>
            <p>No hay im√°genes en la base de datos</p>
          </div>
        `;
        return;
      }
      
      let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
      
      imagenes.forEach((imagen, index) => {
        const tamanoKB = imagen.tamano ? (imagen.tamano / 1024).toFixed(2) : '?';
        
        html += `
          <div 
            onclick="seleccionarImagen(${index})"
            style="
              display: flex;
              align-items: center;
              gap: 15px;
              padding: 12px;
              background: ${index === imagenActualIndex ? '#e0f2fe' : 'white'};
              border-radius: 8px;
              border: 1px solid ${index === imagenActualIndex ? '#3b82f6' : '#e2e8f0'};
              cursor: pointer;
              transition: all 0.3s;
            "
            onmouseenter="this.style.background='${index === imagenActualIndex ? '#e0f2fe' : '#f8fafc'}';"
            onmouseleave="this.style.background='${index === imagenActualIndex ? '#e0f2fe' : 'white'}';"
          >
            <div style="
              width: 50px;
              height: 50px;
              border-radius: 6px;
              overflow: hidden;
              flex-shrink: 0;
              background: #f1f5f9;
            ">
              <img 
                src="${imagen.dataUrl || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f1f5f9"/><text x="50" y="50" font-family="Arial" font-size="10" text-anchor="middle" fill="%2394a3b8">?</text></svg>'}" 
                alt="Miniatura"
                style="width: 100%; height: 100%; object-fit: cover;"
              >
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: #333; margin-bottom: 3px;">
                ${imagen.nombre}
              </div>
              <div style="font-size: 0.8rem; color: #666;">
                ${imagen.tipo_mime || 'Imagen'} | ${tamanoKB} KB
                ${imagen.fecha ? ` | ${imagen.fecha}` : ''}
              </div>
            </div>
            <div style="
              background: ${index === imagenActualIndex ? '#3b82f6' : '#94a3b8'};
              color: white;
              width: 30px;
              height: 30px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 0.9rem;
              font-weight: bold;
            ">
              ${index + 1}
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // 7. Seleccionar imagen desde la lista
    window.seleccionarImagen = function(index) {
      imagenActualIndex = index;
      mostrarCarrusel();
      mostrarMiniaturas();
      mostrarListaImagenes();
    };
    
    // 8. Convertir archivo a Base64
    function convertirABase64(archivo) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          resolve(e.target.result);
        };
        
        reader.onerror = function(error) {
          reject(error);
        };
        
        reader.readAsDataURL(archivo);
      });
    }
    
    // 9. Manejar selecci√≥n de archivo
    function manejarSeleccionArchivo(event) {
      const archivo = event.target.files[0];
      
      if (!archivo) return;
      
      // Validar tipo de archivo
      if (!archivo.type.startsWith('image/')) {
        mostrarMensaje('‚ùå El archivo debe ser una imagen', 'error');
        return;
      }
      
      // Validar tama√±o (m√°ximo 2MB)
      const MAX_SIZE = 2 * 1024 * 1024; // 2MB
      if (archivo.size > MAX_SIZE) {
        mostrarMensaje(`‚ùå La imagen es muy grande. M√°ximo 2MB (tienes: ${(archivo.size / 1024 / 1024).toFixed(2)}MB)`, 'error');
        return;
      }
      
      archivoSeleccionado = archivo;
      
      // Mostrar vista previa
      const vistaPreviaContainer = document.getElementById('vistaPreviaContainer');
      const vistaPrevia = document.getElementById('vistaPrevia');
      const infoArchivo = document.getElementById('infoArchivo');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        vistaPrevia.innerHTML = `
          <img src="${e.target.result}" alt="Vista previa" style="width: 100%; height: 100%; object-fit: cover;">
        `;
        
        infoArchivo.innerHTML = `
          ${archivo.name}<br>
          ${(archivo.size / 1024).toFixed(2)} KB | ${archivo.type}
        `;
        
        vistaPreviaContainer.style.display = 'block';
        
        // Habilitar bot√≥n de subir
        document.getElementById('btnSubir').disabled = false;
        
        // Generar nombre autom√°tico si el campo est√° vac√≠o
        const nombreInput = document.getElementById('inputNombre');
        if (!nombreInput.value.trim()) {
          nombreInput.value = archivo.name.replace(/\.[^/.]+$/, ""); // Quitar extensi√≥n
        }
        
        // Guardar Base64 para enviar
        imagenBase64 = e.target.result;
        tipoMime = archivo.type;
      };
      
      reader.readAsDataURL(archivo);
    }
    
    // 10. Subir imagen al servidor - CON DIAGN√ìSTICO COMPLETO
    async function subirImagen() {
      if (!archivoSeleccionado || !imagenBase64) {
        mostrarMensaje('‚ùå Primero selecciona una imagen', 'error');
        return;
      }
      
      const nombre = document.getElementById('inputNombre').value.trim();
      if (!nombre) {
        mostrarMensaje('‚ùå Ingresa un nombre para la imagen', 'error');
        return;
      }
      
      const btnSubir = document.getElementById('btnSubir');
      const barraProgreso = document.getElementById('barraProgreso');
      const progreso = document.getElementById('progreso');
      
      // Configurar progreso
      barraProgreso.style.display = 'block';
      progreso.style.width = '30%';
      
      // Deshabilitar bot√≥n
      const textoOriginal = btnSubir.innerHTML;
      btnSubir.innerHTML = '‚è≥ Convirtiendo a Base64...';
      btnSubir.disabled = true;
      
      try {
        progreso.style.width = '60%';
        btnSubir.innerHTML = '‚è≥ Subiendo a PostgreSQL...';
        
        // DIAGN√ìSTICO: Mostrar qu√© estamos enviando
        console.log('üì§ Enviando datos al servidor:', {
          nombre: nombre,
          tieneBase64: !!imagenBase64,
          tipoMime: tipoMime,
          longitudBase64: imagenBase64.length,
          timestamp: new Date().toISOString()
        });
        
        // Enviar al servidor
        const respuesta = await fetch(`${BACKEND_URL}/api/carrusel`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            nombre: nombre,
            imagen_base64: imagenBase64,
            tipo_mime: tipoMime
          })
        });
        
        progreso.style.width = '90%';
        
        // ============================================
        // DIAGN√ìSTICO DETALLADO
        // ============================================
        console.log('üîç DIAGN√ìSTICO - Respuesta HTTP:', {
          status: respuesta.status,
          statusText: respuesta.statusText,
          ok: respuesta.ok,
          url: respuesta.url,
          headers: Object.fromEntries(respuesta.headers.entries())
        });
        
        // Verificar si la respuesta es OK
        if (!respuesta.ok) {
          const errorText = await respuesta.text();
          console.error('‚ùå Error texto completo del servidor:', errorText);
          
          // Intentar parsear como JSON
          try {
            const errorJson = JSON.parse(errorText);
            console.error('‚ùå Error JSON del servidor:', errorJson);
            throw new Error(`HTTP ${respuesta.status}: ${errorJson.error || errorJson.message || JSON.stringify(errorJson)}`);
          } catch {
            // Si no es JSON, usar el texto plano
            throw new Error(`HTTP ${respuesta.status}: ${errorText}`);
          }
        }
        
        const datos = await respuesta.json();
        console.log('üì• Respuesta JSON del servidor:', datos);
        // ============================================
        // FIN DIAGN√ìSTICO
        // ============================================
        
        if (datos.success) {
          progreso.style.width = '100%';
          mostrarMensaje(`‚úÖ Imagen "${datos.imagen.nombre}" subida exitosamente`, 'success');
          
          // Limpiar formulario
          limpiarFormulario();
          
          // Recargar im√°genes despu√©s de un breve retraso
          setTimeout(async () => {
            await cargarImagenes();
          }, 1000);
          
          // Ocultar barra de progreso despu√©s de 1 segundo
          setTimeout(() => {
            barraProgreso.style.display = 'none';
            progreso.style.width = '0%';
          }, 1000);
        } else {
          // Mejor manejo de errores
          const errorMsg = datos.message || datos.error || 'Error desconocido';
          console.error('‚ùå Error del servidor:', {
            error: errorMsg,
            datosCompletos: datos
          });
          mostrarMensaje(`‚ùå Error: ${errorMsg}`, 'error');
          
          // Si es error de columna faltante, dar instrucci√≥n espec√≠fica
          if (errorMsg.includes('column') && errorMsg.includes('does not exist')) {
            console.error('‚ö†Ô∏è ERROR DE BASE DE DATOS: Falta columna en PostgreSQL');
            console.error('üîÑ El servidor est√° reparando autom√°ticamente. Intenta de nuevo en 30 segundos.');
            
            // Mostrar mensaje amigable
            mostrarMensaje('üîÑ El servidor est√° reparando la base de datos. Intenta subir la imagen nuevamente en 30 segundos.', 'info');
            
            // Reintentar autom√°ticamente despu√©s de 30 segundos
            setTimeout(() => {
              console.log('üîÑ Reintentando autom√°ticamente despu√©s de 30 segundos...');
              // Puedes descomentar esta l√≠nea para reintento autom√°tico:
              // subirImagen();
            }, 30000);
          }
        }
      } catch (error) {
        console.error('‚ùå Error en subirImagen:', error);
        console.error('‚ùå Stack trace:', error.stack);
        
        // Mensajes m√°s amigables
        if (error.message.includes('Failed to fetch')) {
          mostrarMensaje('‚ùå No se pudo conectar al servidor. Verifica tu conexi√≥n a internet.', 'error');
        } else if (error.message.includes('500')) {
          mostrarMensaje('üîÑ El servidor est√° reparando las tablas autom√°ticamente. Intenta de nuevo en 30 segundos.', 'info');
          
          // Reintentar autom√°ticamente despu√©s de 30 segundos
          setTimeout(() => {
            console.log('üîÑ Reintentando autom√°ticamente despu√©s de error 500...');
            // Puedes descomentar esta l√≠nea para reintento autom√°tico:
            // subirImagen();
          }, 30000);
        } else if (error.message.includes('column') && error.message.includes('does not exist')) {
          mostrarMensaje('üîÑ Error de columna en la base de datos. El servidor est√° reparando autom√°ticamente. Intenta en 30 segundos.', 'info');
        } else {
          mostrarMensaje(`‚ùå Error: ${error.message}`, 'error');
        }
      } finally {
        // Restaurar bot√≥n
        btnSubir.innerHTML = textoOriginal;
        btnSubir.disabled = false;
      }
    }
    
    // 11. Limpiar formulario
    function limpiarFormulario() {
      document.getElementById('inputNombre').value = '';
      document.getElementById('inputArchivo').value = '';
      document.getElementById('vistaPreviaContainer').style.display = 'none';
      document.getElementById('btnSubir').disabled = true;
      archivoSeleccionado = null;
      imagenBase64 = '';
      tipoMime = '';
    }
    
    // 12. Mostrar mensajes
    function mostrarMensaje(texto, tipo) {
      const mensajeDiv = document.getElementById('mensajeResultado');
      mensajeDiv.textContent = texto;
      mensajeDiv.style.display = 'block';
      
      // Colores seg√∫n tipo
      if (tipo === 'success') {
        mensajeDiv.style.background = '#d1fae5';
        mensajeDiv.style.color = '#065f46';
        mensajeDiv.style.border = '2px solid #10b981';
      } else if (tipo === 'error') {
        mensajeDiv.style.background = '#fee2e2';
        mensajeDiv.style.color = '#991b1b';
        mensajeDiv.style.border = '2px solid #ef4444';
      } else if (tipo === 'info') {
        mensajeDiv.style.background = '#e0f2fe';
        mensajeDiv.style.color = '#1e40af';
        mensajeDiv.style.border = '2px solid #3b82f6';
      }
      
      // Auto-ocultar despu√©s de 5 segundos
      setTimeout(() => {
        mensajeDiv.style.display = 'none';
      }, 5000);
    }
    
    function mostrarError(texto) {
      const container = document.getElementById('carruselContainer');
      container.innerHTML = `
        <div style="text-align: center; color: #991b1b; padding: 60px;">
          <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
          <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;">${texto}</p>
          <p style="font-size: 0.9rem; margin-top: 10px;">
            Verifica que el servidor est√© funcionando:<br>
            <a href="${BACKEND_URL}/health" target="_blank" style="color: #3b82f6; text-decoration: underline;">
              ${BACKEND_URL}/health
            </a>
          </p>
          <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
            <button onclick="location.reload()" style="
              background: #3b82f6;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 5px;
              cursor: pointer;
            ">
              üîÑ Reintentar
            </button>
            <button onclick="probarConexion()" style="
              background: #10b981;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 5px;
              cursor: pointer;
            ">
              üß™ Probar Conexi√≥n
            </button>
          </div>
        </div>
      `;
    }
    
    // ====================
    // EVENT LISTENERS
    // ====================
    
    document.addEventListener('DOMContentLoaded', function() {
      // Cargar im√°genes al inicio
      cargarImagenes();
      
      // Configurar selector de archivos
      const inputArchivo = document.getElementById('inputArchivo');
      const dropZone = document.getElementById('dropZone');
      const btnSubir = document.getElementById('btnSubir');
      
      // Click en la zona de drop
      dropZone.addEventListener('click', () => {
        inputArchivo.click();
      });
      
      // Cambio en el input de archivo
      inputArchivo.addEventListener('change', manejarSeleccionArchivo);
      
      // Drag and drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.background = '#dbeafe';
        dropZone.style.borderColor = '#1d4ed8';
      });
      
      dropZone.addEventListener('dragleave', () => {
        dropZone.style.background = '#f0f9ff';
        dropZone.style.borderColor = '#3b82f6';
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = '#f0f9ff';
        dropZone.style.borderColor = '#3b82f6';
        
        if (e.dataTransfer.files.length) {
          inputArchivo.files = e.dataTransfer.files;
          manejarSeleccionArchivo({ target: inputArchivo });
        }
      });
      
      // Bot√≥n de subir
      btnSubir.addEventListener('click', subirImagen);
      
      // Configurar controles del carrusel
      document.getElementById('btnAnterior').addEventListener('click', function() {
        if (imagenActualIndex > 0) {
          imagenActualIndex--;
          mostrarCarrusel();
          mostrarMiniaturas();
          mostrarListaImagenes();
        }
      });
      
      document.getElementById('btnSiguiente').addEventListener('click', function() {
        if (imagenActualIndex < imagenes.length - 1) {
          imagenActualIndex++;
          mostrarCarrusel();
          mostrarMiniaturas();
          mostrarListaImagenes();
        }
      });
      
      // Permitir navegaci√≥n con teclado
      document.addEventListener('keydown', function(e) {
        if (imagenes.length === 0) return;
        
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          if (imagenActualIndex > 0) {
            imagenActualIndex--;
            mostrarCarrusel();
            mostrarMiniaturas();
            mostrarListaImagenes();
          }
        } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          e.preventDefault();
          if (imagenActualIndex < imagenes.length - 1) {
            imagenActualIndex++;
            mostrarCarrusel();
            mostrarMiniaturas();
            mostrarListaImagenes();
          }
        }
      });
      
      // Autoplay cada 5 segundos (solo si hay m√°s de 1 imagen)
      let autoplayInterval = setInterval(() => {
        if (imagenes.length > 1) {
          imagenActualIndex = (imagenActualIndex + 1) % imagenes.length;
          mostrarCarrusel();
          mostrarMiniaturas();
          mostrarListaImagenes();
        }
      }, 5000);
      
      // Pausar autoplay al hacer hover
      const carruselContainer = document.getElementById('carruselContainer');
      carruselContainer.addEventListener('mouseenter', () => {
        clearInterval(autoplayInterval);
      });
      
      carruselContainer.addEventListener('mouseleave', () => {
        autoplayInterval = setInterval(() => {
          if (imagenes.length > 1) {
            imagenActualIndex = (imagenActualIndex + 1) % imagenes.length;
            mostrarCarrusel();
            mostrarMiniaturas();
            mostrarListaImagenes();
          }
        }, 5000);
      });
      
      // Bot√≥n de prueba en la interfaz (opcional)
      const botonPrueba = document.createElement('button');
      //botonPrueba.innerHTML = 'üß™ Probar Conexi√≥n';
      botonPrueba.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #8b5cf6;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      `;
      botonPrueba.onclick = probarConexion;
      document.body.appendChild(botonPrueba);
    });
  </script>
</Layout>