---
// src/pages/carrusel.astro
---

<nav style="
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 15px 20px;
  border-radius: 0 0 15px 15px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  margin-bottom: 40px;
">
  <div style="
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
  ">
    <!-- Logo/TÃ­tulo -->
    <div style="display: flex; align-items: center; gap: 10px;">
      <div style="
        background: white;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #667eea;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      ">
        ğŸš€
      </div>
      <h1 style="color: white; margin: 0; font-size: 1.5rem; font-weight: 600;">
        Astro + PostgreSQL
      </h1>
    </div>

    <!-- MenÃº de navegaciÃ³n -->
    <div style="
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    ">
      <a 
        href="https://czalbert6.github.io/violet-virgo/" 
        style="
          padding: 10px 20px;
          background: rgba(255, 255, 255, 0.2);
          color: white;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 500;
          transition: all 0.3s;
          border: 1px solid rgba(255, 255, 255, 0.3);
          display: flex;
          align-items: center;
          gap: 8px;
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-2px)';"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='translateY(0)';"
      >
        <span>ğŸ </span>
        <span>Inicio</span>
      </a>
      
      <a 
        href="https://czalbert6.github.io/violet-virgo/formulario-validacion/" 
        style="
          padding: 10px 20px;
          background: rgba(255, 255, 255, 0.2);
          color: white;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 500;
          transition: all 0.3s;
          border: 1px solid rgba(255, 255, 255, 0.3);
          display: flex;
          align-items: center;
          gap: 8px;
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-2px)';"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='translateY(0)';"
      >
        <span>ğŸ“</span>
        <span>Formulario</span>
      </a>
      
      <a 
        href="https://czalbert6.github.io/violet-virgo/error-captcha/" 
        style="
          padding: 10px 20px;
          background: rgba(255, 255, 255, 0.2);
          color: white;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 500;
          transition: all 0.3s;
          border: 1px solid rgba(255, 255, 255, 0.3);
          display: flex;
          align-items: center;
          gap: 8px;
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(-2px)';"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='translateY(0)';"
      >
        <span>âš ï¸</span>
        <span>Error Captcha</span>
      </a>
      
      <a 
        href="carrusel" 
        style="
          padding: 10px 20px;
          background: rgba(255, 255, 255, 0.3);
          color: white;
          text-decoration: none;
          border-radius: 8px;
          font-weight: 600;
          transition: all 0.3s;
          border: 2px solid rgba(255, 255, 255, 0.5);
          display: flex;
          align-items: center;
          gap: 8px;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        "
        onmouseover="this.style.background='rgba(255, 255, 255, 0.4)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 0, 0, 0.3)';"
        onmouseout="this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.2)';"
      >
        <span>ğŸ–¼ï¸</span>
        <span>Carrusel</span>
      </a>
    </div>
  </div>
</nav>

<div style="
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  font-family: Arial, sans-serif;
">
  <!-- TÃ­tulo -->
  <h1 style="
    color: #333;
    text-align: center;
    margin-bottom: 10px;
    font-size: 2.2rem;
  ">
    ğŸ–¼ï¸ Carrusel de ImÃ¡genes
  </h1>
  <p style="color: #666; text-align: center; margin-bottom: 40px;">
    Sube imÃ¡genes desde tu dispositivo a PostgreSQL (Base64)
  </p>

  <!-- Contenedor principal -->
  <div style="display: grid; grid-template-columns: 1fr; gap: 40px;">
    
    <!-- SecciÃ³n 1: Carrusel -->
    <div>
      <h2 style="color: #333; margin-bottom: 20px; font-size: 1.5rem;">
        ğŸ“¸ Vista Previa del Carrusel
      </h2>
      
      <!-- Carrusel -->
      <div id="carruselContainer" style="
        width: 100%;
        height: 400px;
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
      ">
        <!-- Mensaje cuando no hay imÃ¡genes -->
        <div id="sinImagenes" style="text-align: center; color: #94a3b8; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“·</div>
          <p>No hay imÃ¡genes en el carrusel</p>
          <p style="font-size: 0.9rem; margin-top: 10px;">Sube tu primera imagen abajo</p>
        </div>
        
        <!-- Imagen actual (se muestra dinÃ¡micamente) -->
        <div id="imagenActual" style="
          display: none;
          width: 100%;
          height: 100%;
          position: relative;
        "></div>
      </div>

      <!-- Controles del carrusel -->
      <div style="
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
      ">
        <button 
          id="btnAnterior"
          style="
            background: #3b82f6;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
          "
          onmouseenter="this.style.background='#2563eb'; this.style.transform='scale(1.1)';"
          onmouseleave="this.style.background='#3b82f6'; this.style.transform='scale(1)';"
          disabled
        >
          â—€
        </button>
        
        <div style="text-align: center; min-width: 100px;">
          <div id="contador" style="
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
          ">0 / 0</div>
          <div id="nombreImagen" style="
            font-size: 0.9rem;
            color: #666;
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
          "></div>
        </div>
        
        <button 
          id="btnSiguiente"
          style="
            background: #3b82f6;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
          "
          onmouseenter="this.style.background='#2563eb'; this.style.transform='scale(1.1)';"
          onmouseleave="this.style.background='#3b82f6'; this.style.transform='scale(1)';"
          disabled
        >
          â–¶
        </button>
      </div>

      <!-- Miniaturas -->
      <div id="miniaturasContainer" style="
        display: flex;
        gap: 10px;
        padding: 10px;
        overflow-x: auto;
        background: #f8fafc;
        border-radius: 10px;
        min-height: 80px;
      "></div>
    </div>

    <!-- SecciÃ³n 2: Subir imÃ¡genes DESDE DISPOSITIVO -->
    <div>
      <h2 style="color: #333; margin-bottom: 20px; font-size: 1.5rem;">
        ğŸ“¤ Subir Imagen desde tu Dispositivo
      </h2>
      
      <div style="
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
      ">
        <!-- Selector de archivos -->
        <div style="margin-bottom: 25px;">
          <label style="
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
          ">
            ğŸ“ Selecciona una imagen *
          </label>
          
          <div style="
            border: 2px dashed #3b82f6;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: #f0f9ff;
            cursor: pointer;
            transition: all 0.3s;
          "
          id="dropZone"
          onmouseenter="this.style.background='#e0f2fe'; this.style.borderColor='#2563eb';"
          onmouseleave="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6';">
            <input 
              type="file" 
              id="inputArchivo"
              accept="image/*"
              style="display: none;"
            >
            
            <div style="font-size: 48px; margin-bottom: 15px; color: #3b82f6;">
              ğŸ“¤
            </div>
            <div style="font-weight: 600; color: #1e40af; margin-bottom: 10px;">
              Haz clic o arrastra una imagen aquÃ­
            </div>
            <div style="color: #475569; font-size: 0.9rem; margin-bottom: 15px;">
              Formatos aceptados: JPG, PNG, GIF, WebP
            </div>
            <div style="color: #64748b; font-size: 0.85rem;">
              MÃ¡ximo 2MB por imagen
            </div>
          </div>
          
          <!-- Vista previa de la imagen seleccionada -->
          <div id="vistaPreviaContainer" style="
            margin-top: 20px;
            display: none;
            text-align: center;
          ">
            <div style="font-weight: 600; color: #555; margin-bottom: 10px;">
              ğŸ“‹ Vista previa:
            </div>
            <div id="vistaPrevia" style="
              max-width: 200px;
              max-height: 200px;
              margin: 0 auto;
              border-radius: 8px;
              overflow: hidden;
              border: 2px solid #e2e8f0;
            "></div>
            <div id="infoArchivo" style="
              margin-top: 10px;
              color: #666;
              font-size: 0.9rem;
            "></div>
          </div>
        </div>
        
        <!-- Campo para nombre -->
        <div style="margin-bottom: 25px;">
          <label style="
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
          ">
            ğŸ“ Nombre para la imagen *
          </label>
          <input 
            type="text" 
            id="inputNombre"
            placeholder="Ej: Mi foto de vacaciones"
            style="
              width: 100%;
              padding: 12px 15px;
              border: 2px solid #e2e8f0;
              border-radius: 8px;
              font-size: 16px;
              transition: all 0.3s;
            "
            required
            onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
            onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';"
          >
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            Nombre descriptivo para identificar la imagen
          </div>
        </div>
        
        <!-- BotÃ³n de subir -->
        <button 
          id="btnSubir"
          style="
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
          "
          onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 5px 15px rgba(16, 185, 129, 0.4)';"
          onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
          disabled
        >
          <span>ğŸ“¤</span>
          <span>Subir Imagen a PostgreSQL</span>
        </button>
        
        <!-- Barra de progreso -->
        <div id="barraProgreso" style="
          margin-top: 20px;
          height: 6px;
          background: #e2e8f0;
          border-radius: 3px;
          overflow: hidden;
          display: none;
        ">
          <div id="progreso" style="
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.3s;
          "></div>
        </div>
        
        <!-- Mensaje de resultado -->
        <div id="mensajeResultado" style="
          margin-top: 20px;
          padding: 15px;
          border-radius: 10px;
          display: none;
          text-align: center;
          font-weight: 600;
        "></div>
      </div>
      
      <!-- Lista de imÃ¡genes existentes -->
      <div style="margin-top: 30px;">
        <h3 style="color: #333; margin-bottom: 15px; font-size: 1.2rem;">
          ğŸ—‚ï¸ ImÃ¡genes en la Base de Datos
        </h3>
        <div id="listaImagenes" style="
          background: #f8fafc;
          border-radius: 10px;
          padding: 15px;
          max-height: 300px;
          overflow-y: auto;
          border: 1px solid #e2e8f0;
        ">
          <div style="text-align: center; color: #94a3b8; padding: 40px;">
            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“‹</div>
            <p>Cargando imÃ¡genes...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // ====================
  // CONFIGURACIÃ“N
  // ====================
  const BACKEND_URL = 'https://violet-virgo-production.up.railway.app';
  let imagenes = [];
  let imagenActualIndex = 0;
  let archivoSeleccionado = null;
  let imagenBase64 = '';
  let tipoMime = '';
  
  // ====================
  // FUNCIÃ“N DE PRUEBA RÃPIDA (para diagnÃ³stico)
  // ====================
  window.probarConexion = async function() {
    console.log('ğŸ§ª Probando conexiÃ³n con el backend...');
    
    try {
      // 1. Probar GET /api/carrusel
      console.log('1ï¸âƒ£ Probando GET /api/carrusel...');
      const getRespuesta = await fetch(`${BACKEND_URL}/api/carrusel`);
      console.log('ğŸ“¤ GET Status:', getRespuesta.status, getRespuesta.statusText);
      
      if (!getRespuesta.ok) {
        const errorText = await getRespuesta.text();
        console.error('âŒ GET Error:', errorText);
        mostrarMensaje(`âŒ GET Error: ${getRespuesta.status} ${errorText}`, 'error');
        return;
      }
      
      const getDatos = await getRespuesta.json();
      console.log('âœ… GET funcionando:', getDatos);
      
      // 2. Probar POST con imagen pequeÃ±a de prueba
      console.log('2ï¸âƒ£ Probando POST /api/carrusel...');
      const imagenTest = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
      
      const datosPrueba = {
        nombre: 'test_' + Date.now(),
        imagen_base64: imagenTest,
        tipo_mime: 'image/png'
      };
      
      console.log('ğŸ“¤ Enviando datos de prueba:', datosPrueba);
      
      const postRespuesta = await fetch(`${BACKEND_URL}/api/carrusel`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(datosPrueba)
      });
      
      console.log('ğŸ“¥ POST Status:', postRespuesta.status, postRespuesta.statusText);
      console.log('ğŸ“¥ POST Headers:', Object.fromEntries(postRespuesta.headers.entries()));
      
      if (!postRespuesta.ok) {
        const errorText = await postRespuesta.text();
        console.error('âŒ POST Error texto completo:', errorText);
        try {
          const errorJson = JSON.parse(errorText);
          console.error('âŒ POST Error JSON:', errorJson);
          mostrarMensaje(`âŒ POST Error ${postRespuesta.status}: ${errorJson.error || errorJson.message || errorText}`, 'error');
        } catch {
          mostrarMensaje(`âŒ POST Error ${postRespuesta.status}: ${errorText}`, 'error');
        }
        return;
      }
      
      const postDatos = await postRespuesta.json();
      console.log('âœ… POST funcionando:', postDatos);
      mostrarMensaje('âœ… Â¡ConexiÃ³n y envÃ­o funcionan correctamente!', 'success');
      
      // 3. Recargar imÃ¡genes para mostrar el test
      setTimeout(() => {
        cargarImagenes();
      }, 1000);
      
    } catch (error) {
      console.error('âŒ Error en prueba:', error);
      console.error('âŒ Stack trace:', error.stack);
      mostrarMensaje(`âŒ Error de conexiÃ³n: ${error.message}`, 'error');
    }
  };
  
  // ====================
  // FUNCIONES PRINCIPALES
  // ====================
  
  // 1. Cargar imÃ¡genes desde el backend - MEJORADA
  async function cargarImagenes() {
    try {
      console.log('ğŸ”„ Cargando imÃ¡genes...');
      const respuesta = await fetch(`${BACKEND_URL}/api/carrusel`, {
        method: 'GET',
        headers: {
          'Accept': 'application/json'
        }
      });
      
      // Verificar si la respuesta es OK
      if (!respuesta.ok) {
        const errorText = await respuesta.text();
        throw new Error(`HTTP ${respuesta.status}: ${errorText}`);
      }
      
      const datos = await respuesta.json();
      console.log('ğŸ“¥ Respuesta del servidor:', datos);
      
      if (datos.success) {
        imagenes = datos.imagenes || [];
        console.log(`âœ… ${imagenes.length} imÃ¡genes cargadas`);
        
        if (imagenes.length > 0) {
          // Para cada imagen, cargar el Base64
          await cargarImagenesCompletas();
          mostrarCarrusel();
          mostrarMiniaturas();
          mostrarListaImagenes();
        } else {
          mostrarCarruselVacio();
        }
      } else {
        console.error('âŒ Error del servidor:', datos);
        mostrarMensaje(`Error: ${datos.message || datos.error || 'Error desconocido'}`, 'error');
      }
    } catch (error) {
      console.error('âŒ Error cargando imÃ¡genes:', error);
      
      // Mensaje amigable para el usuario
      if (error.message.includes('Failed to fetch')) {
        mostrarError('No se pudo conectar al servidor. Verifica tu conexiÃ³n a internet.');
      } else if (error.message.includes('500')) {
        mostrarError('Error interno del servidor. El servidor estÃ¡ reparando las tablas automÃ¡ticamente. Intenta de nuevo en 30 segundos.');
        
        // Intentar nuevamente despuÃ©s de 5 segundos
        setTimeout(() => {
          console.log('ğŸ”„ Reintentando carga...');
          cargarImagenes();
        }, 5000);
      } else {
        mostrarError('Error: ' + error.message);
      }
    }
  }
  
  // 2. Cargar imÃ¡genes completas con Base64
  async function cargarImagenesCompletas() {
    const nuevasImagenes = [];
    
    for (const imagen of imagenes) {
      try {
        const respuesta = await fetch(`${BACKEND_URL}/api/carrusel/${imagen.id}`);
        
        if (!respuesta.ok) {
          console.warn(`âš ï¸ Error cargando imagen ${imagen.id}:`, respuesta.status);
          continue;
        }
        
        const datos = await respuesta.json();
        
        if (datos.success && datos.imagen.imagen_base64) {
          // Crear URL temporal para la imagen
          imagen.dataUrl = datos.imagen.imagen_base64;
          nuevasImagenes.push(imagen);
        }
      } catch (error) {
        console.error(`Error cargando imagen ${imagen.id}:`, error);
      }
    }
    
    imagenes = nuevasImagenes;
  }
  
  // 3. Mostrar carrusel vacÃ­o
  function mostrarCarruselVacio() {
    document.getElementById('sinImagenes').style.display = 'block';
    document.getElementById('imagenActual').style.display = 'none';
    document.getElementById('contador').textContent = '0 / 0';
    document.getElementById('nombreImagen').textContent = '';
    
    // Deshabilitar controles
    document.getElementById('btnAnterior').disabled = true;
    document.getElementById('btnSiguiente').disabled = true;
    document.getElementById('btnAnterior').style.background = '#cbd5e1';
    document.getElementById('btnSiguiente').style.background = '#cbd5e1';
    
    // Limpiar miniaturas
    document.getElementById('miniaturasContainer').innerHTML = '';
    
    // Actualizar lista
    document.getElementById('listaImagenes').innerHTML = `
      <div style="text-align: center; color: #94a3b8; padding: 40px;">
        <div style="font-size: 32px; margin-bottom: 10px;">ğŸ”„</div>
        <p>No hay imÃ¡genes en la base de datos</p>
        <p style="font-size: 0.9rem; margin-top: 10px;">Sube tu primera imagen arriba</p>
      </div>
    `;
  }
  
  // 4. Mostrar imagen en el carrusel
  function mostrarCarrusel() {
    if (imagenes.length === 0) {
      mostrarCarruselVacio();
      return;
    }
    
    const imagen = imagenes[imagenActualIndex];
    
    // Ocultar mensaje de vacÃ­o
    document.getElementById('sinImagenes').style.display = 'none';
    document.getElementById('imagenActual').style.display = 'block';
    
    // Mostrar imagen desde Base64
    document.getElementById('imagenActual').innerHTML = `
      <div style="
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
      ">
        <img 
          src="${imagen.dataUrl || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f1f5f9"/><text x="50" y="50" font-family="Arial" font-size="10" text-anchor="middle" fill="%2394a3b8">Imagen no disponible</text></svg>'}" 
          alt="${imagen.nombre}"
          style="
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
          "
        >
      </div>
      <div style="
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 15px;
        text-align: center;
      ">
        <div style="font-weight: 600; margin-bottom: 5px;">${imagen.nombre}</div>
        <div style="font-size: 0.8rem; opacity: 0.8;">
          ${imagen.tamano ? `TamaÃ±o: ${(imagen.tamano / 1024).toFixed(2)} KB` : ''}
          ${imagen.fecha ? ` | Subida: ${imagen.fecha}` : ''}
        </div>
      </div>
    `;
    
    // Actualizar contador
    document.getElementById('contador').textContent = `${imagenActualIndex + 1} / ${imagenes.length}`;
    document.getElementById('nombreImagen').textContent = imagen.nombre;
    
    // Habilitar/deshabilitar controles
    const btnAnterior = document.getElementById('btnAnterior');
    const btnSiguiente = document.getElementById('btnSiguiente');
    
    btnAnterior.disabled = imagenActualIndex === 0;
    btnSiguiente.disabled = imagenActualIndex === imagenes.length - 1;
    
    btnAnterior.style.background = btnAnterior.disabled ? '#cbd5e1' : '#3b82f6';
    btnSiguiente.style.background = btnSiguiente.disabled ? '#cbd5e1' : '#3b82f6';
  }
  
  // 5. Mostrar miniaturas
  function mostrarMiniaturas() {
    const container = document.getElementById('miniaturasContainer');
    container.innerHTML = '';
    
    imagenes.forEach((imagen, index) => {
      const miniatura = document.createElement('div');
      miniatura.style.cssText = `
        width: 70px;
        height: 70px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        opacity: ${index === imagenActualIndex ? '1' : '0.6'};
        border: ${index === imagenActualIndex ? '3px solid #3b82f6' : '1px solid #e2e8f0'};
        flex-shrink: 0;
        transition: all 0.3s;
        background: white;
      `;
      
      miniatura.innerHTML = `
        <img 
          src="${imagen.dataUrl || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f1f5f9"/><text x="50" y="50" font-family="Arial" font-size="10" text-anchor="middle" fill="%2394a3b8">?</text></svg>'}" 
          alt="Miniatura"
          style="width: 100%; height: 100%; object-fit: cover;"
        >
      `;
      
      miniatura.onclick = () => {
        imagenActualIndex = index;
        mostrarCarrusel();
        mostrarMiniaturas();
      };
      
      miniatura.onmouseenter = () => {
        if (index !== imagenActualIndex) {
          miniatura.style.opacity = '0.8';
          miniatura.style.transform = 'scale(1.05)';
        }
      };
      
      miniatura.onmouseleave = () => {
        if (index !== imagenActualIndex) {
          miniatura.style.opacity = '0.6';
          miniatura.style.transform = 'scale(1)';
        }
      };
      
      container.appendChild(miniatura);
    });
  }
  
  // 6. Mostrar lista de imÃ¡genes
  function mostrarListaImagenes() {
    const container = document.getElementById('listaImagenes');
    
    if (imagenes.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; color: #94a3b8; padding: 40px;">
          <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“­</div>
          <p>No hay imÃ¡genes en la base de datos</p>
        </div>
      `;
      return;
    }
    
    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
    
    imagenes.forEach((imagen, index) => {
      const tamanoKB = imagen.tamano ? (imagen.tamano / 1024).toFixed(2) : '?';
      
      html += `
        <div 
          onclick="seleccionarImagen(${index})"
          style="
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: ${index === imagenActualIndex ? '#e0f2fe' : 'white'};
            border-radius: 8px;
            border: 1px solid ${index === imagenActualIndex ? '#3b82f6' : '#e2e8f0'};
            cursor: pointer;
            transition: all 0.3s;
          "
          onmouseenter="this.style.background='${index === imagenActualIndex ? '#e0f2fe' : '#f8fafc'}';"
          onmouseleave="this.style.background='${index === imagenActualIndex ? '#e0f2fe' : 'white'}';"
        >
          <div style="
            width: 50px;
            height: 50px;
            border-radius: 6px;
            overflow: hidden;
            flex-shrink: 0;
            background: #f1f5f9;
          ">
            <img 
              src="${imagen.dataUrl || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f1f5f9"/><text x="50" y="50" font-family="Arial" font-size="10" text-anchor="middle" fill="%2394a3b8">?</text></svg>'}" 
              alt="Miniatura"
              style="width: 100%; height: 100%; object-fit: cover;"
            >
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 600; color: #333; margin-bottom: 3px;">
              ${imagen.nombre}
            </div>
            <div style="font-size: 0.8rem; color: #666;">
              ${imagen.tipo_mime || 'Imagen'} | ${tamanoKB} KB
              ${imagen.fecha ? ` | ${imagen.fecha}` : ''}
            </div>
          </div>
          <div style="
            background: ${index === imagenActualIndex ? '#3b82f6' : '#94a3b8'};
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
          ">
            ${index + 1}
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    container.innerHTML = html;
  }
  
  // 7. Seleccionar imagen desde la lista
  window.seleccionarImagen = function(index) {
    imagenActualIndex = index;
    mostrarCarrusel();
    mostrarMiniaturas();
    mostrarListaImagenes();
  };
  
  // 8. Convertir archivo a Base64
  function convertirABase64(archivo) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        resolve(e.target.result);
      };
      
      reader.onerror = function(error) {
        reject(error);
      };
      
      reader.readAsDataURL(archivo);
    });
  }
  
  // 9. Manejar selecciÃ³n de archivo
  function manejarSeleccionArchivo(event) {
    const archivo = event.target.files[0];
    
    if (!archivo) return;
    
    // Validar tipo de archivo
    if (!archivo.type.startsWith('image/')) {
      mostrarMensaje('âŒ El archivo debe ser una imagen', 'error');
      return;
    }
    
    // Validar tamaÃ±o (mÃ¡ximo 2MB)
    const MAX_SIZE = 2 * 1024 * 1024; // 2MB
    if (archivo.size > MAX_SIZE) {
      mostrarMensaje(`âŒ La imagen es muy grande. MÃ¡ximo 2MB (tienes: ${(archivo.size / 1024 / 1024).toFixed(2)}MB)`, 'error');
      return;
    }
    
    archivoSeleccionado = archivo;
    
    // Mostrar vista previa
    const vistaPreviaContainer = document.getElementById('vistaPreviaContainer');
    const vistaPrevia = document.getElementById('vistaPrevia');
    const infoArchivo = document.getElementById('infoArchivo');
    
    const reader = new FileReader();
    reader.onload = function(e) {
      vistaPrevia.innerHTML = `
        <img src="${e.target.result}" alt="Vista previa" style="width: 100%; height: 100%; object-fit: cover;">
      `;
      
      infoArchivo.innerHTML = `
        ${archivo.name}<br>
        ${(archivo.size / 1024).toFixed(2)} KB | ${archivo.type}
      `;
      
      vistaPreviaContainer.style.display = 'block';
      
      // Habilitar botÃ³n de subir
      document.getElementById('btnSubir').disabled = false;
      
      // Generar nombre automÃ¡tico si el campo estÃ¡ vacÃ­o
      const nombreInput = document.getElementById('inputNombre');
      if (!nombreInput.value.trim()) {
        nombreInput.value = archivo.name.replace(/\.[^/.]+$/, ""); // Quitar extensiÃ³n
      }
      
      // Guardar Base64 para enviar
      imagenBase64 = e.target.result;
      tipoMime = archivo.type;
    };
    
    reader.readAsDataURL(archivo);
  }
  
  // 10. Subir imagen al servidor - CON DIAGNÃ“STICO COMPLETO
  async function subirImagen() {
    if (!archivoSeleccionado || !imagenBase64) {
      mostrarMensaje('âŒ Primero selecciona una imagen', 'error');
      return;
    }
    
    const nombre = document.getElementById('inputNombre').value.trim();
    if (!nombre) {
      mostrarMensaje('âŒ Ingresa un nombre para la imagen', 'error');
      return;
    }
    
    const btnSubir = document.getElementById('btnSubir');
    const barraProgreso = document.getElementById('barraProgreso');
    const progreso = document.getElementById('progreso');
    
    // Configurar progreso
    barraProgreso.style.display = 'block';
    progreso.style.width = '30%';
    
    // Deshabilitar botÃ³n
    const textoOriginal = btnSubir.innerHTML;
    btnSubir.innerHTML = 'â³ Convirtiendo a Base64...';
    btnSubir.disabled = true;
    
    try {
      progreso.style.width = '60%';
      btnSubir.innerHTML = 'â³ Subiendo a PostgreSQL...';
      
      // DIAGNÃ“STICO: Mostrar quÃ© estamos enviando
      console.log('ğŸ“¤ Enviando datos al servidor:', {
        nombre: nombre,
        tieneBase64: !!imagenBase64,
        tipoMime: tipoMime,
        longitudBase64: imagenBase64.length,
        timestamp: new Date().toISOString()
      });
      
      // Enviar al servidor
      const respuesta = await fetch(`${BACKEND_URL}/api/carrusel`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          nombre: nombre,
          imagen_base64: imagenBase64,
          tipo_mime: tipoMime
        })
      });
      
      progreso.style.width = '90%';
      
      // ============================================
      // DIAGNÃ“STICO DETALLADO
      // ============================================
      console.log('ğŸ” DIAGNÃ“STICO - Respuesta HTTP:', {
        status: respuesta.status,
        statusText: respuesta.statusText,
        ok: respuesta.ok,
        url: respuesta.url,
        headers: Object.fromEntries(respuesta.headers.entries())
      });
      
      // Verificar si la respuesta es OK
      if (!respuesta.ok) {
        const errorText = await respuesta.text();
        console.error('âŒ Error texto completo del servidor:', errorText);
        
        // Intentar parsear como JSON
        try {
          const errorJson = JSON.parse(errorText);
          console.error('âŒ Error JSON del servidor:', errorJson);
          throw new Error(`HTTP ${respuesta.status}: ${errorJson.error || errorJson.message || JSON.stringify(errorJson)}`);
        } catch {
          // Si no es JSON, usar el texto plano
          throw new Error(`HTTP ${respuesta.status}: ${errorText}`);
        }
      }
      
      const datos = await respuesta.json();
      console.log('ğŸ“¥ Respuesta JSON del servidor:', datos);
      // ============================================
      // FIN DIAGNÃ“STICO
      // ============================================
      
      if (datos.success) {
        progreso.style.width = '100%';
        mostrarMensaje(`âœ… Imagen "${datos.imagen.nombre}" subida exitosamente`, 'success');
        
        // Limpiar formulario
        limpiarFormulario();
        
        // Recargar imÃ¡genes despuÃ©s de un breve retraso
        setTimeout(async () => {
          await cargarImagenes();
        }, 1000);
        
        // Ocultar barra de progreso despuÃ©s de 1 segundo
        setTimeout(() => {
          barraProgreso.style.display = 'none';
          progreso.style.width = '0%';
        }, 1000);
      } else {
        // Mejor manejo de errores
        const errorMsg = datos.message || datos.error || 'Error desconocido';
        console.error('âŒ Error del servidor:', {
          error: errorMsg,
          datosCompletos: datos
        });
        mostrarMensaje(`âŒ Error: ${errorMsg}`, 'error');
        
        // Si es error de columna faltante, dar instrucciÃ³n especÃ­fica
        if (errorMsg.includes('column') && errorMsg.includes('does not exist')) {
          console.error('âš ï¸ ERROR DE BASE DE DATOS: Falta columna en PostgreSQL');
          console.error('ğŸ”„ El servidor estÃ¡ reparando automÃ¡ticamente. Intenta de nuevo en 30 segundos.');
          
          // Mostrar mensaje amigable
          mostrarMensaje('ğŸ”„ El servidor estÃ¡ reparando la base de datos. Intenta subir la imagen nuevamente en 30 segundos.', 'info');
          
          // Reintentar automÃ¡ticamente despuÃ©s de 30 segundos
          setTimeout(() => {
            console.log('ğŸ”„ Reintentando automÃ¡ticamente despuÃ©s de 30 segundos...');
            // Puedes descomentar esta lÃ­nea para reintento automÃ¡tico:
            // subirImagen();
          }, 30000);
        }
      }
    } catch (error) {
      console.error('âŒ Error en subirImagen:', error);
      console.error('âŒ Stack trace:', error.stack);
      
      // Mensajes mÃ¡s amigables
      if (error.message.includes('Failed to fetch')) {
        mostrarMensaje('âŒ No se pudo conectar al servidor. Verifica tu conexiÃ³n a internet.', 'error');
      } else if (error.message.includes('500')) {
        mostrarMensaje('ğŸ”„ El servidor estÃ¡ reparando las tablas automÃ¡ticamente. Intenta de nuevo en 30 segundos.', 'info');
        
        // Reintentar automÃ¡ticamente despuÃ©s de 30 segundos
        setTimeout(() => {
          console.log('ğŸ”„ Reintentando automÃ¡ticamente despuÃ©s de error 500...');
          // Puedes descomentar esta lÃ­nea para reintento automÃ¡tico:
          // subirImagen();
        }, 30000);
      } else if (error.message.includes('column') && error.message.includes('does not exist')) {
        mostrarMensaje('ğŸ”„ Error de columna en la base de datos. El servidor estÃ¡ reparando automÃ¡ticamente. Intenta en 30 segundos.', 'info');
      } else {
        mostrarMensaje(`âŒ Error: ${error.message}`, 'error');
      }
    } finally {
      // Restaurar botÃ³n
      btnSubir.innerHTML = textoOriginal;
      btnSubir.disabled = false;
    }
  }
  
  // 11. Limpiar formulario
  function limpiarFormulario() {
    document.getElementById('inputNombre').value = '';
    document.getElementById('inputArchivo').value = '';
    document.getElementById('vistaPreviaContainer').style.display = 'none';
    document.getElementById('btnSubir').disabled = true;
    archivoSeleccionado = null;
    imagenBase64 = '';
    tipoMime = '';
  }
  
  // 12. Mostrar mensajes
  function mostrarMensaje(texto, tipo) {
    const mensajeDiv = document.getElementById('mensajeResultado');
    mensajeDiv.textContent = texto;
    mensajeDiv.style.display = 'block';
    
    // Colores segÃºn tipo
    if (tipo === 'success') {
      mensajeDiv.style.background = '#d1fae5';
      mensajeDiv.style.color = '#065f46';
      mensajeDiv.style.border = '2px solid #10b981';
    } else if (tipo === 'error') {
      mensajeDiv.style.background = '#fee2e2';
      mensajeDiv.style.color = '#991b1b';
      mensajeDiv.style.border = '2px solid #ef4444';
    } else if (tipo === 'info') {
      mensajeDiv.style.background = '#e0f2fe';
      mensajeDiv.style.color = '#1e40af';
      mensajeDiv.style.border = '2px solid #3b82f6';
    }
    
    // Auto-ocultar despuÃ©s de 5 segundos
    setTimeout(() => {
      mensajeDiv.style.display = 'none';
    }, 5000);
  }
  
  function mostrarError(texto) {
    const container = document.getElementById('carruselContainer');
    container.innerHTML = `
      <div style="text-align: center; color: #991b1b; padding: 60px;">
        <div style="font-size: 48px; margin-bottom: 10px;">âŒ</div>
        <p style="font-size: 1.2rem; font-weight: bold; margin-bottom: 15px;">${texto}</p>
        <p style="font-size: 0.9rem; margin-top: 10px;">
          Verifica que el servidor estÃ© funcionando:<br>
          <a href="${BACKEND_URL}/health" target="_blank" style="color: #3b82f6; text-decoration: underline;">
            ${BACKEND_URL}/health
          </a>
        </p>
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
          <button onclick="location.reload()" style="
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
          ">
            ğŸ”„ Reintentar
          </button>
          <button onclick="probarConexion()" style="
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
          ">
            ğŸ§ª Probar ConexiÃ³n
          </button>
        </div>
      </div>
    `;
  }
  
  // ====================
  // EVENT LISTENERS
  // ====================
  
  document.addEventListener('DOMContentLoaded', function() {
    // Cargar imÃ¡genes al inicio
    cargarImagenes();
    
    // Configurar selector de archivos
    const inputArchivo = document.getElementById('inputArchivo');
    const dropZone = document.getElementById('dropZone');
    const btnSubir = document.getElementById('btnSubir');
    
    // Click en la zona de drop
    dropZone.addEventListener('click', () => {
      inputArchivo.click();
    });
    
    // Cambio en el input de archivo
    inputArchivo.addEventListener('change', manejarSeleccionArchivo);
    
    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.background = '#dbeafe';
      dropZone.style.borderColor = '#1d4ed8';
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.style.background = '#f0f9ff';
      dropZone.style.borderColor = '#3b82f6';
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.background = '#f0f9ff';
      dropZone.style.borderColor = '#3b82f6';
      
      if (e.dataTransfer.files.length) {
        inputArchivo.files = e.dataTransfer.files;
        manejarSeleccionArchivo({ target: inputArchivo });
      }
    });
    
    // BotÃ³n de subir
    btnSubir.addEventListener('click', subirImagen);
    
    // Configurar controles del carrusel
    document.getElementById('btnAnterior').addEventListener('click', function() {
      if (imagenActualIndex > 0) {
        imagenActualIndex--;
        mostrarCarrusel();
        mostrarMiniaturas();
        mostrarListaImagenes();
      }
    });
    
    document.getElementById('btnSiguiente').addEventListener('click', function() {
      if (imagenActualIndex < imagenes.length - 1) {
        imagenActualIndex++;
        mostrarCarrusel();
        mostrarMiniaturas();
        mostrarListaImagenes();
      }
    });
    
    // Permitir navegaciÃ³n con teclado
    document.addEventListener('keydown', function(e) {
      if (imagenes.length === 0) return;
      
      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (imagenActualIndex > 0) {
          imagenActualIndex--;
          mostrarCarrusel();
          mostrarMiniaturas();
          mostrarListaImagenes();
        }
      } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        if (imagenActualIndex < imagenes.length - 1) {
          imagenActualIndex++;
          mostrarCarrusel();
          mostrarMiniaturas();
          mostrarListaImagenes();
        }
      }
    });
    
    // Autoplay cada 5 segundos (solo si hay mÃ¡s de 1 imagen)
    let autoplayInterval = setInterval(() => {
      if (imagenes.length > 1) {
        imagenActualIndex = (imagenActualIndex + 1) % imagenes.length;
        mostrarCarrusel();
        mostrarMiniaturas();
        mostrarListaImagenes();
      }
    }, 5000);
    
    // Pausar autoplay al hacer hover
    const carruselContainer = document.getElementById('carruselContainer');
    carruselContainer.addEventListener('mouseenter', () => {
      clearInterval(autoplayInterval);
    });
    
    carruselContainer.addEventListener('mouseleave', () => {
      autoplayInterval = setInterval(() => {
        if (imagenes.length > 1) {
          imagenActualIndex = (imagenActualIndex + 1) % imagenes.length;
          mostrarCarrusel();
          mostrarMiniaturas();
          mostrarListaImagenes();
        }
      }, 5000);
    });
  });
</script>